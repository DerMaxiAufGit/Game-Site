---
phase: 01-foundation-infrastructure
plan: 04
type: execute
wave: 4
depends_on: ["01-03"]
files_modified:
  - src/app/(app)/admin/layout.tsx
  - src/app/(app)/admin/page.tsx
  - src/components/admin/stats-cards.tsx
  - src/components/admin/user-table.tsx
  - src/components/admin/invite-dialog.tsx
  - src/components/admin/ban-dialog.tsx
  - src/lib/actions/admin.ts
  - src/lib/email/invite.ts
autonomous: true
user_setup:
  - service: resend
    why: "Sending invite emails to users"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
      - name: RESEND_FROM_EMAIL
        source: "Your verified domain email or Resend's onboarding@resend.dev for testing"
    dashboard_config:
      - task: "Create Resend account and get API key"
        location: "https://resend.com/signup"
  - service: postgresql
    why: "Database for users, invites"
    env_vars:
      - name: DATABASE_URL
        source: "PostgreSQL connection string (local or hosted like Neon/Railway)"

must_haves:
  truths:
    - "Admin sees dashboard with user stats (total users, active, pending invites)"
    - "Admin can send invite via email to a new user"
    - "Admin can generate a shareable invite link (for WhatsApp, Discord)"
    - "Admin can ban a user with an optional reason"
    - "Admin can unban a previously banned user"
    - "Non-admin users are redirected away from /admin"
    - "Invite email is sent asynchronously (does not block UI)"
  artifacts:
    - path: "src/app/(app)/admin/page.tsx"
      provides: "Admin dashboard with stats and user management"
      contains: "admin"
    - path: "src/components/admin/user-table.tsx"
      provides: "Table of all users with ban/unban actions"
      contains: "UserTable"
    - path: "src/components/admin/invite-dialog.tsx"
      provides: "Dialog for creating invites (email or link)"
      contains: "InviteDialog"
    - path: "src/components/admin/ban-dialog.tsx"
      provides: "Dialog for banning user with reason field"
      contains: "BanDialog"
    - path: "src/lib/actions/admin.ts"
      provides: "Server actions for invite, ban, unban"
      contains: "createInvite"
    - path: "src/lib/email/invite.ts"
      provides: "Email sending via Resend"
      contains: "sendInviteEmail"
  key_links:
    - from: "src/app/(app)/admin/page.tsx"
      to: "src/lib/auth/dal.ts"
      via: "requireAdmin check"
      pattern: "requireAdmin"
    - from: "src/components/admin/invite-dialog.tsx"
      to: "src/lib/actions/admin.ts"
      via: "createInvite server action"
      pattern: "createInvite"
    - from: "src/lib/actions/admin.ts"
      to: "src/lib/email/invite.ts"
      via: "async email sending (fire and forget)"
      pattern: "sendInviteEmail.*\\.catch"
    - from: "src/lib/actions/admin.ts"
      to: "src/lib/db/index.ts"
      via: "prisma queries for invites and user management"
      pattern: "prisma\\.(invite|user)\\."
    - from: "src/app/(app)/admin/layout.tsx"
      to: "src/lib/auth/dal.ts"
      via: "requireAdmin for route protection"
      pattern: "requireAdmin"
---

<objective>
Build the admin dashboard with user management (list, ban, unban), invite system (send email + generate shareable link), and overview statistics. This completes the admin's core capabilities for managing the invite-based community.

Purpose: The admin dashboard is how the community owner manages users and grows the platform. Without it, no new users can be invited and problematic users cannot be moderated.
Output: Fully functional /admin route with stats, user table, invite creation, and ban/unban functionality.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin server actions and email integration</name>
  <files>
    src/lib/actions/admin.ts
    src/lib/email/invite.ts
  </files>
  <action>
    1. Create src/lib/email/invite.ts:
       - Import Resend from 'resend'
       - Initialize Resend client with RESEND_API_KEY from env
       - sendInviteEmail(email: string, token: string, invitedBy: string):
         a. Build invite URL: `${NEXT_PUBLIC_APP_URL}/register?token=${token}`
         b. Send email via Resend with:
            - From: RESEND_FROM_EMAIL
            - To: email
            - Subject: "Du wurdest zu Kniff eingeladen!"
            - HTML body: Simple, clean email in German explaining the invitation, who invited them, and a button/link to register
         c. Return success/error
       - If RESEND_API_KEY is not set, log warning and skip email (for dev without Resend configured)

    2. Create src/lib/actions/admin.ts with 'use server' directive:

       a. createInvite(prevState, formData):
          - Call requireAdmin() first
          - Parse email from formData, validate with zod (valid email)
          - Check if email is already registered (db.user.findUnique by email)
          - If already registered, return { error: 'User already exists' }
          - Check if there's already a pending (unused, unexpired) invite for this email
          - If pending invite exists, return that invite's link instead of creating new one
          - Generate cryptographically secure token: crypto.randomBytes(32).toString('hex')
          - Create invite in database with 7-day expiry
          - Return { success: true, token, link: `${APP_URL}/register?token=${token}` }
          - If formData includes sendEmail=true, fire-and-forget sendInviteEmail (PITFALL 8 — don't await, use .catch for error logging)

       b. banUser(prevState, formData):
          - Call requireAdmin()
          - Parse userId and optional reason from formData
          - Prevent banning yourself (compare with session userId)
          - Prevent banning other admins (check target user's role)
          - Update user: set bannedAt to now(), bannedReason to reason
          - revalidatePath('/admin')
          - Return { success: true }

       c. unbanUser(prevState, formData):
          - Call requireAdmin()
          - Parse userId from formData
          - Update user: set bannedAt to null, bannedReason to null
          - revalidatePath('/admin')
          - Return { success: true }

       d. getAdminStats():
          - Call requireAdmin()
          - Query in parallel:
            - Total users: db.user.count()
            - Active now: for v1, just return total non-banned users (real online count comes with Socket.IO tracking in later phases)
            - Pending invites: db.invite.count() where usedAt is null AND expiresAt > now()
          - Return { totalUsers, activeNow, pendingInvites }

       e. getUsers():
          - Call requireAdmin()
          - Fetch all users with: id, username, displayName, email, role, createdAt, bannedAt, bannedReason
          - Order by createdAt desc
          - Return users array

       f. getInvites():
          - Call requireAdmin()
          - Fetch recent invites (last 50) with: id, email, token, createdAt, expiresAt, usedAt, creator info
          - Return invites array

    CRITICAL: All actions must call requireAdmin() as first operation. Email sending MUST be fire-and-forget (don't block the response). Use crypto.randomBytes for token generation (not Math.random).
  </action>
  <verify>
    1. `npm run build` passes
    2. TypeScript: no type errors
    3. All admin actions exported: createInvite, banUser, unbanUser, getAdminStats, getUsers, getInvites
    4. Email function handles missing API key gracefully (logs warning, doesn't crash)
  </verify>
  <done>
    - createInvite generates secure token, saves to DB, optionally sends email
    - banUser/unbanUser update user status with reason tracking
    - getAdminStats returns dashboard statistics
    - getUsers/getInvites fetch data for admin views
    - Email sending is async and non-blocking
    - All actions require admin role
  </done>
</task>

<task type="auto">
  <name>Task 2: Build admin dashboard UI (stats, user table, invite dialog, ban dialog)</name>
  <files>
    src/app/(app)/admin/layout.tsx
    src/app/(app)/admin/page.tsx
    src/components/admin/stats-cards.tsx
    src/components/admin/user-table.tsx
    src/components/admin/invite-dialog.tsx
    src/components/admin/ban-dialog.tsx
  </files>
  <action>
    1. Create src/app/(app)/admin/layout.tsx:
       - Server component that calls requireAdmin()
       - If not admin, this redirects automatically (requireAdmin handles it)
       - Simple wrapper layout — can add admin-specific header/breadcrumb if desired
       - Pass through children

    2. Create src/components/admin/stats-cards.tsx:
       - Receives stats data as props: { totalUsers, activeNow, pendingInvites }
       - Three Card components in a responsive grid (1 col mobile, 3 cols desktop)
       - Each card: icon (Users, Activity, Mail from Lucide), label in German, large number
       - Green accent for key numbers
       - Use translations from de.json admin namespace

    3. Create src/components/admin/user-table.tsx:
       - Receives users array as props
       - shadcn/ui Table component
       - Columns: Username, Anzeigename, E-Mail, Rolle, Status (Aktiv/Gesperrt), Erstellt am, Aktionen
       - Status column: green Badge for "Aktiv", red Badge for "Gesperrt"
       - Role column: Badge showing ADMIN or USER
       - Actions column: Ban button (for active users), Unban button (for banned users)
       - Ban button opens BanDialog, Unban triggers server action directly with confirmation
       - Skip actions for the currently logged-in admin (can't ban yourself)
       - German labels for everything
       - Responsive: on mobile, consider a card-based layout or horizontal scroll

    4. Create src/components/admin/invite-dialog.tsx:
       - 'use client' component
       - Uses shadcn/ui Dialog
       - Triggered by "Nutzer einladen" button (with Mail/Plus icon)
       - Form inside dialog:
         - Email input field
         - Two action buttons: "Per E-Mail senden" and "Link generieren"
         - "Per E-Mail senden" calls createInvite with sendEmail=true
         - "Link generieren" calls createInvite with sendEmail=false, then shows the generated link
       - After successful generation: show the invite link in a copyable field with "Link kopiert!" toast on click
       - Show loading states during server action
       - Show errors via toast (duplicate email, etc.)
       - All labels in German

    5. Create src/components/admin/ban-dialog.tsx:
       - 'use client' component
       - Uses shadcn/ui Dialog
       - Receives userId and username as props
       - Form: optional "Grund" (reason) textarea
       - Submit calls banUser server action
       - Confirmation text: "Möchtest du [username] wirklich sperren?"
       - Loading state on submit
       - Close dialog and show success toast after ban

    6. Create src/app/(app)/admin/page.tsx:
       - Server component
       - Calls getAdminStats(), getUsers(), getInvites() in parallel (Promise.all)
       - Renders:
         a. Page title: "Admin-Dashboard" with admin icon
         b. StatsCards with stats data
         c. "Nutzer einladen" button that opens InviteDialog
         d. UserTable with users data
       - German labels from translations
       - Clean layout with proper spacing

    STYLE NOTES:
    - Dashboard should feel like a proper admin panel — organized, clean
    - Stats cards at top in a row, user table below
    - Green accent for positive actions (invite), red/destructive for ban
    - Dialogs have dark theme styling matching the overall app
    - Table rows have subtle hover states
    - Badge colors: green for active, red for banned, blue/purple for admin role
  </action>
  <verify>
    1. `npm run build` passes
    2. Visit /admin as admin — dashboard renders with stats and user table
    3. Visit /admin as non-admin — redirected away
    4. Click "Nutzer einladen" — dialog opens with email field and two action buttons
    5. Generate invite link — link appears in copyable field
    6. Click ban on a user — ban dialog opens with reason field
    7. After banning — user shows "Gesperrt" badge in table
    8. Click unban — user returns to "Aktiv" status
    9. Mobile: dashboard is usable (cards stack, table scrolls or adapts)
  </verify>
  <done>
    - Admin dashboard displays stats cards (total users, active, pending invites)
    - User table lists all users with role, status, and action buttons
    - Invite dialog supports both email sending and link generation
    - Ban dialog captures optional reason before banning
    - Unban restores user access
    - All UI is in German with proper dark theme styling
    - Non-admin users cannot access /admin
  </done>
</task>

</tasks>

<verification>
1. Admin dashboard loads with accurate stats
2. Invite via email: enter email -> "Per E-Mail senden" -> invite created (email sent if Resend configured)
3. Invite via link: enter email -> "Link generieren" -> copyable link shown
4. Use generated link in browser -> /register page loads with pre-filled email
5. Ban user: click ban -> enter reason -> confirm -> user shows as banned in table
6. Unban user: click unban -> confirm -> user shows as active
7. Banned user tries to log in -> gets "Account gesperrt" error
8. Banned user with active session -> gets logged out on next request (DAL check)
9. Non-admin visiting /admin -> redirected to home
</verification>

<success_criteria>
- Admin can view dashboard with user statistics
- Admin can invite users via email or shareable link
- Admin can ban and unban users with reason tracking
- Invite tokens are cryptographically secure with 7-day expiry
- Email sending does not block the admin UI
- All admin pages are protected (admin role required)
- All text is in German
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md`
</output>
