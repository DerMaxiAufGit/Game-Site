---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - next.config.js
  - postcss.config.mjs
  - src/app/globals.css
  - src/app/layout.tsx
  - src/lib/utils.ts
  - components.json
  - tailwind.config.ts
  - prisma/schema.prisma
  - src/lib/db/index.ts
  - src/messages/de.json
  - src/i18n/request.ts
  - src/types/index.ts
  - .env.local
  - .env.example
  - .gitignore
  - server.js
  - src/lib/auth/session.ts
  - src/lib/auth/dal.ts
  - src/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Next.js dev server starts without errors using custom server.js"
    - "Prisma schema validates and database can be pushed"
    - "shadcn/ui components render with dark theme and green accent"
    - "German translations load via next-intl"
    - "Auth session can be created and verified programmatically"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "User and Invite models with Role enum"
      contains: "model User"
    - path: "src/lib/auth/session.ts"
      provides: "JWT session creation and verification"
      contains: "createSession"
    - path: "src/lib/auth/dal.ts"
      provides: "Data Access Layer with cached session check"
      contains: "getSession"
    - path: "src/middleware.ts"
      provides: "Route protection and session refresh"
      contains: "middleware"
    - path: "server.js"
      provides: "Custom Node.js server for Next.js + Socket.IO"
      contains: "createServer"
    - path: "src/messages/de.json"
      provides: "German translations for all UI strings"
      contains: "auth"
    - path: "src/lib/db/index.ts"
      provides: "Prisma client singleton"
      contains: "prisma"
  key_links:
    - from: "src/lib/auth/dal.ts"
      to: "src/lib/auth/session.ts"
      via: "imports verifySession"
      pattern: "import.*verifySession.*from.*session"
    - from: "src/middleware.ts"
      to: "src/lib/auth/session.ts"
      via: "session verification and refresh"
      pattern: "decrypt|encrypt|jwtVerify"
    - from: "src/lib/auth/dal.ts"
      to: "src/lib/db/index.ts"
      via: "database query for user"
      pattern: "prisma\\.user\\.findUnique"
---

<objective>
Initialize the complete project foundation: Next.js 15 App Router with TypeScript, Prisma + PostgreSQL database schema, shadcn/ui with dark theme and green accent, next-intl German translations, custom server.js for Socket.IO, and the core authentication library (session management, DAL, middleware).

Purpose: Every subsequent plan depends on this foundation. Without a working project skeleton, auth library, and database schema, nothing else can be built.
Output: A running Next.js dev server with database schema pushed, auth utilities ready to use, and all UI infrastructure configured.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js project with all dependencies and configuration</name>
  <files>
    package.json
    tsconfig.json
    next.config.js
    postcss.config.mjs
    src/app/globals.css
    src/app/layout.tsx
    src/lib/utils.ts
    components.json
    tailwind.config.ts
    prisma/schema.prisma
    src/lib/db/index.ts
    src/messages/de.json
    src/i18n/request.ts
    src/types/index.ts
    .env.local
    .env.example
    .gitignore
    server.js
  </files>
  <action>
    1. Initialize Next.js 15 project with App Router and TypeScript in the current directory (game-site is already the project root, no src/ subdirectory duplication):
       ```
       npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*"
       ```
       If prompted about existing files, proceed (only .planning exists).

    2. Install all dependencies from RESEARCH.md:
       ```bash
       # Core
       npm install prisma @prisma/client socket.io socket.io-client next-intl

       # UI & styling
       npm install class-variance-authority clsx tailwind-merge lucide-react tw-animate-css next-themes

       # Auth & security
       npm install bcrypt jose zod
       npm install @types/bcrypt --save-dev

       # Forms & UX
       npm install react-hook-form @hookform/resolvers sonner

       # Email
       npm install resend
       ```

    3. Initialize shadcn/ui:
       ```
       npx shadcn@latest init
       ```
       Select: New York style, Zinc base color (we'll override with green accent). This creates components.json and updates globals.css.

    4. Add essential shadcn/ui components:
       ```
       npx shadcn@latest add button input label card form toast separator badge dropdown-menu sheet avatar table dialog
       ```

    5. Configure globals.css with dark mode default and rich green accent (Stammtisch felt). Override the shadcn/ui CSS variables:
       - Dark mode as default (class="dark" on html)
       - Primary color: rich green (~hsl(142, 70%, 40%)) for buttons, links, active states
       - Background: dark tones
       - Card/surface: slightly lighter dark
       - Keep the modern/clean feel with subtle warmth

    6. Configure next.config.js for next-intl:
       ```javascript
       const createNextIntlPlugin = require('next-intl/plugin')
       const withNextIntl = createNextIntlPlugin()
       module.exports = withNextIntl({})
       ```

    7. Create src/i18n/request.ts:
       ```typescript
       import { getRequestConfig } from 'next-intl/server'
       export default getRequestConfig(async () => ({
         locale: 'de',
         messages: (await import('../messages/de.json')).default
       }))
       ```

    8. Create src/messages/de.json with comprehensive German translations for Phase 1:
       ```json
       {
         "common": { "loading": "Laden...", "save": "Speichern", "cancel": "Abbrechen", "delete": "Löschen", "back": "Zurück", "confirm": "Bestätigen", "error": "Fehler", "success": "Erfolgreich" },
         "auth": { "login": "Anmelden", "logout": "Abmelden", "register": "Registrieren", "email": "E-Mail", "password": "Passwort", "username": "Benutzername", "displayName": "Anzeigename", "setup": "Einrichtung", "setupTitle": "Willkommen bei Kniff", "setupDescription": "Erstelle deinen Admin-Account um loszulegen.", "loginTitle": "Anmelden", "loginDescription": "Melde dich mit deinen Zugangsdaten an.", "registerTitle": "Registrieren", "registerDescription": "Erstelle deinen Account über die Einladung.", "invalidCredentials": "Ungültige Anmeldedaten", "accountBanned": "Dein Account wurde gesperrt", "inviteExpired": "Diese Einladung ist abgelaufen", "inviteUsed": "Diese Einladung wurde bereits verwendet", "inviteNotFound": "Einladung nicht gefunden", "passwordMin": "Mindestens 8 Zeichen", "setupAlreadyDone": "Ein Admin existiert bereits" },
         "admin": { "dashboard": "Admin-Dashboard", "overview": "Übersicht", "users": "Nutzer", "invites": "Einladungen", "totalUsers": "Nutzer gesamt", "activeNow": "Gerade online", "pendingInvites": "Offene Einladungen", "inviteUser": "Nutzer einladen", "sendEmail": "Per E-Mail senden", "generateLink": "Link generieren", "banUser": "Nutzer sperren", "unbanUser": "Nutzer entsperren", "banReason": "Grund (optional)", "banned": "Gesperrt", "active": "Aktiv", "role": "Rolle", "createdAt": "Erstellt am", "actions": "Aktionen", "inviteSent": "Einladung gesendet", "inviteCopied": "Einladungslink kopiert", "userBanned": "Nutzer wurde gesperrt", "userUnbanned": "Nutzer wurde entsperrt" },
         "nav": { "lobby": "Spielelobby", "admin": "Administration", "settings": "Einstellungen", "connectionOnline": "Verbunden", "connectionOffline": "Getrennt" },
         "lobby": { "title": "Spielelobby", "comingSoon": "Spiele kommen bald", "comingSoonDescription": "Hier werden bald Spieltische erscheinen. Bleib dran!" }
       }
       ```

    9. Update src/app/layout.tsx as root layout:
       - Set lang="de" on html tag
       - Add class="dark" on html for default dark mode
       - Wrap with NextIntlClientProvider
       - Add ThemeProvider from next-themes
       - Add Toaster from sonner
       - Use a clean sans-serif font (Inter or Geist — whatever create-next-app provides)

    10. Initialize Prisma with PostgreSQL:
        ```
        npx prisma init --datasource-provider postgresql
        ```

    11. Define prisma/schema.prisma with User and Invite models per RESEARCH.md:
        - User: id (cuid), email (unique), username (unique), displayName, passwordHash, role (enum ADMIN/USER), createdAt, updatedAt, bannedAt (optional), bannedReason (optional)
        - Invite: id (cuid), email, token (unique), expiresAt, usedAt (optional), createdAt, createdBy (relation to User)
        - Add indexes on Invite.token and Invite.email

    12. Create src/lib/db/index.ts with Prisma client singleton (global variable pattern to prevent multiple instances in dev).

    13. Create src/types/index.ts with shared TypeScript types (UserRole, SessionPayload, ActionState for server action returns).

    14. Create .env.example with all required env vars (DATABASE_URL, SESSION_SECRET, RESEND_API_KEY, RESEND_FROM_EMAIL, NEXT_PUBLIC_APP_URL).

    15. Create .env.local with development defaults (DATABASE_URL pointing to localhost PostgreSQL, a generated SESSION_SECRET, placeholder for Resend).

    16. Create server.js (custom Node.js server) per RESEARCH.md Pattern 2:
        - Import createServer from node:http, next, and Socket.IO Server
        - Prepare Next.js app, create HTTP server, attach Socket.IO
        - Basic connection/disconnection logging
        - Socket.IO auth middleware placeholder (will be completed in Plan 03)
        - Listen on port 3000

    17. Update .gitignore to include .env.local, node_modules, .next, prisma/*.db.

    18. Add dev script to package.json: "dev": "node server.js" (replaces default "next dev" to use custom server).

    IMPORTANT: Do NOT use jsonwebtoken — use jose (Edge Runtime compatible). Do NOT use tailwindcss-animate — use tw-animate-css (Tailwind v4 compatible).
  </action>
  <verify>
    1. `npm run build` completes without errors (or `npx next build`)
    2. `npx prisma validate` passes
    3. `npx prisma db push` succeeds (requires running PostgreSQL — if not available, `prisma validate` is sufficient)
    4. All files listed above exist
  </verify>
  <done>
    - Next.js project initialized with all dependencies
    - Prisma schema validates with User and Invite models
    - shadcn/ui configured with dark theme and green accent
    - German translations file exists with all Phase 1 strings
    - Custom server.js exists and can start the dev server
    - .env.example documents all required environment variables
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement core authentication library (session, DAL, middleware)</name>
  <files>
    src/lib/auth/session.ts
    src/lib/auth/dal.ts
    src/middleware.ts
  </files>
  <action>
    1. Create src/lib/auth/session.ts following RESEARCH.md Pattern 1:
       - Mark with 'use server' and import 'server-only'
       - Import SignJWT, jwtVerify from jose
       - Import cookies from next/headers
       - Read SESSION_SECRET from process.env, encode with TextEncoder
       - createSession(userId: string, role: string): creates JWT with { userId, role } payload, 7-day expiry, HS256 algorithm. Sets httpOnly cookie named 'session' with secure, sameSite: 'lax', path: '/'
       - verifySession(): reads 'session' cookie, verifies JWT, returns { userId, role } or null on failure
       - updateSession(): refreshes session expiry (re-signs with new expiration, re-sets cookie). Call this to keep active users logged in.
       - deleteSession(): removes the session cookie

    2. Create src/lib/auth/dal.ts (Data Access Layer) following RESEARCH.md Pattern 1:
       - Import cache from react
       - Import verifySession from ./session
       - Import redirect from next/navigation
       - Import prisma from @/lib/db
       - getSession(): cached function that:
         a. Calls verifySession()
         b. If no session, redirects to /login
         c. Queries database for user by userId
         d. If user not found OR user.bannedAt is set, calls deleteSession() and redirects to /login (PITFALL 7 from research)
         e. Returns { userId, role, username, displayName }
       - getOptionalSession(): same but returns null instead of redirecting (for pages that work with or without auth, like /setup check)
       - requireAdmin(): calls getSession(), checks role === 'ADMIN', redirects to / if not admin

    3. Create src/middleware.ts:
       - Match all routes EXCEPT: /api, /_next/static, /_next/image, favicon.ico, public assets
       - For /setup route: check if any user exists (via lightweight cookie check or allow through — the server action handles the real check)
       - For /login and /register routes: if session exists and valid, redirect to / (already logged in)
       - For all other routes: if no session cookie present, redirect to /login
       - On valid session: refresh session expiry by re-setting cookie (PITFALL 1 from research — session refresh on activity)
       - IMPORTANT: Middleware runs on Edge, so use jose for JWT verification (not bcrypt or prisma). Only do cookie-based checks here. Full auth checks happen in DAL.
       - Middleware should decrypt the JWT to check expiry and role, but NOT query the database (performance concern on every prefetch)

    CRITICAL PITFALLS TO IMPLEMENT:
    - Banned user check in DAL (not just middleware) — Pitfall 7
    - Session refresh on every request — Pitfall 1
    - No database queries in middleware — use jose only
    - deleteSession must clear cookie properly
  </action>
  <verify>
    1. `npm run build` completes without errors (middleware compiles for Edge Runtime)
    2. TypeScript compilation passes with no type errors
    3. session.ts exports: createSession, verifySession, updateSession, deleteSession
    4. dal.ts exports: getSession, getOptionalSession, requireAdmin
  </verify>
  <done>
    - Auth session library creates and verifies JWTs in httpOnly cookies
    - DAL provides cached session checking with banned-user enforcement
    - Middleware protects routes, refreshes sessions, and redirects appropriately
    - All auth utilities are importable and type-safe
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes — entire project compiles
2. `npx prisma validate` — schema is correct
3. Dev server starts with `node server.js` (or npm run dev)
4. All auth exports are available: createSession, verifySession, updateSession, deleteSession, getSession, requireAdmin
5. German translations load (verify by checking de.json has all keys)
6. Dark theme with green accent is applied (globals.css has correct CSS variables)
</verification>

<success_criteria>
- Running Next.js dev server via custom server.js
- Prisma schema with User and Invite models validates
- Auth library (session + DAL + middleware) compiles and exports correctly
- shadcn/ui components available with dark theme + green accent
- German translation file with all Phase 1 strings
- All environment variables documented in .env.example
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>
