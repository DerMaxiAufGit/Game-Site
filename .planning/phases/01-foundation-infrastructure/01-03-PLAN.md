---
phase: 01-foundation-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/app/(app)/layout.tsx
  - src/app/(app)/page.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/mobile-sidebar.tsx
  - src/components/layout/connection-status.tsx
  - src/components/layout/user-menu.tsx
  - src/lib/socket/client.ts
  - src/lib/socket/provider.tsx
  - server.js
autonomous: true

must_haves:
  truths:
    - "Authenticated user sees sidebar with navigation links"
    - "Lobby page shows placeholder message in German"
    - "Sidebar collapses to hamburger menu on mobile"
    - "WebSocket connects automatically after login"
    - "Connection status indicator shows online/offline state"
    - "WebSocket reconnects automatically after network interruption"
  artifacts:
    - path: "src/app/(app)/layout.tsx"
      provides: "App shell with sidebar, protected by auth"
      contains: "getSession"
    - path: "src/app/(app)/page.tsx"
      provides: "Lobby placeholder page"
      contains: "comingSoon"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Vertical sidebar with nav links and connection status"
      contains: "Sidebar"
    - path: "src/lib/socket/provider.tsx"
      provides: "Socket.IO React context provider"
      contains: "SocketProvider"
    - path: "src/lib/socket/client.ts"
      provides: "Socket.IO client instance creation"
      contains: "socket"
    - path: "server.js"
      provides: "Custom server with Socket.IO auth middleware"
      contains: "io.use"
  key_links:
    - from: "src/app/(app)/layout.tsx"
      to: "src/lib/auth/dal.ts"
      via: "getSession for auth check"
      pattern: "getSession"
    - from: "src/app/(app)/layout.tsx"
      to: "src/lib/socket/provider.tsx"
      via: "wraps children with SocketProvider"
      pattern: "SocketProvider"
    - from: "src/lib/socket/provider.tsx"
      to: "src/lib/socket/client.ts"
      via: "creates socket connection"
      pattern: "io\\("
    - from: "server.js"
      to: "src/lib/auth/session.ts"
      via: "verifies session cookie in Socket.IO middleware"
      pattern: "jwtVerify|verifySession"
    - from: "src/components/layout/connection-status.tsx"
      to: "src/lib/socket/provider.tsx"
      via: "reads socket connection state from context"
      pattern: "useSocket"
---

<objective>
Build the main application shell (sidebar navigation, lobby placeholder) and the WebSocket infrastructure (Socket.IO integration in custom server, client provider, authentication middleware, connection status indicator with auto-reconnection).

Purpose: The app shell is the container for all future game features. WebSocket infrastructure enables real-time game state sync. Both are prerequisites for the admin dashboard and all subsequent phases.
Output: A working authenticated app with sidebar navigation, WebSocket connection with auth, and visible connection status.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build app shell with sidebar navigation and lobby placeholder</name>
  <files>
    src/app/(app)/layout.tsx
    src/app/(app)/page.tsx
    src/components/layout/sidebar.tsx
    src/components/layout/mobile-sidebar.tsx
    src/components/layout/user-menu.tsx
  </files>
  <action>
    1. Create src/components/layout/sidebar.tsx:
       - Vertical sidebar, fixed on the left side, full height
       - Width: ~64px collapsed icon view or ~240px expanded (Claude's discretion on exact approach)
       - Dark background with subtle border on the right
       - "Kniff" branding at the top (text logo with green accent)
       - Navigation links with icons (Lucide React):
         - Spielelobby (Gamepad2 or Dice icon) — links to /
         - Administration (Shield or Settings icon) — links to /admin, ONLY shown if user.role === 'ADMIN'
       - Connection status indicator at the bottom (ConnectionStatus component — placeholder for now, wired in Task 2)
       - User menu at the bottom: shows username/display name, avatar placeholder (first letter), dropdown with "Abmelden" (logout) option
       - Sidebar receives user data as props (passed from layout server component)
       - Green accent for active nav item

    2. Create src/components/layout/mobile-sidebar.tsx:
       - Uses shadcn/ui Sheet component (slides in from left)
       - Triggered by hamburger menu icon (Menu from Lucide) in a top bar
       - Contains same navigation items as desktop sidebar
       - Top bar: hamburger icon on left, "Kniff" text center, user avatar on right
       - Sheet closes on nav link click
       - Only renders on mobile breakpoints (md:hidden for mobile bar, hidden md:block for desktop sidebar)

    3. Create src/components/layout/user-menu.tsx:
       - Uses shadcn/ui DropdownMenu
       - Trigger: avatar (first letter of displayName) + displayName text
       - Menu items: "Abmelden" (calls logout server action)
       - Styled for dark theme

    4. Create src/app/(app)/layout.tsx (protected app layout):
       - Server component that calls getSession() from DAL (redirects to /login if not authenticated)
       - Fetches user data from database (username, displayName, role)
       - Renders desktop sidebar + mobile sidebar + main content area
       - Main content area: has left padding to account for sidebar on desktop
       - Wraps children with SocketProvider (added in Task 2 — for now, just render children directly. Task 2 will add the provider wrapper)
       - Passes user data to sidebar components

    5. Create src/app/(app)/page.tsx (lobby placeholder):
       - Simple centered content: icon + "Spiele kommen bald" heading + "Hier werden bald Spieltische erscheinen. Bleib dran!" description
       - Use German translations from de.json (lobby.comingSoon, lobby.comingSoonDescription)
       - Styled with dark theme, maybe a subtle Dice or Gamepad icon above the text
       - This page will be replaced in Phase 2 with the actual lobby

    STYLE NOTES:
    - Sidebar: dark background (slightly lighter than page bg), green accent on active items
    - Clean transitions on hover states
    - Mobile: full-width top bar with hamburger, content takes full width
    - Desktop: sidebar always visible, content offset to the right
    - Modern feel with subtle card-like sections in the sidebar
    - Responsive breakpoint at md (768px)
  </action>
  <verify>
    1. `npm run build` passes
    2. After login, user sees sidebar with navigation links
    3. Lobby page shows German placeholder message
    4. Admin link only shows for admin role users
    5. Mobile viewport: sidebar collapses, hamburger menu works
    6. Logout button in user menu calls logout action
  </verify>
  <done>
    - Desktop sidebar renders with Kniff branding, nav links, and user menu
    - Mobile sidebar uses Sheet component triggered by hamburger menu
    - Admin link only visible to admin users
    - Lobby placeholder displays German "coming soon" message
    - Logout works via user menu dropdown
    - Layout is responsive across mobile and desktop viewports
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Socket.IO with auth middleware, provider, and connection status</name>
  <files>
    server.js
    src/lib/socket/client.ts
    src/lib/socket/provider.tsx
    src/components/layout/connection-status.tsx
    src/app/(app)/layout.tsx
  </files>
  <action>
    1. Update server.js to add Socket.IO authentication middleware:
       - Import jose (jwtVerify) for session cookie verification
       - Read SESSION_SECRET from process.env (use dotenv or .env.local loading — Next.js loads .env.local automatically when using next(), but for jose in server.js you may need to read it manually)
       - Add io.use() middleware that:
         a. Extracts 'session' cookie from socket.request.headers.cookie (parse cookie string)
         b. Verifies JWT using jose
         c. If valid, sets socket.data.userId and socket.data.role from payload
         d. If invalid/missing, calls next(new Error('Authentication required'))
       - On 'connection': log userId connected
       - On 'disconnect': log userId disconnected
       - Add 'request-state' handler stub (for future reconnection — just acknowledge for now)
       - Configure Socket.IO with reconnection settings:
         - reconnectionDelay: 1000
         - reconnectionDelayMax: 30000
         - reconnectionAttempts: Infinity (within 60s window for game state)

    2. Create src/lib/socket/client.ts:
       - Export a function getSocket() that returns a singleton Socket.IO client instance
       - Use io() with autoConnect: false (connect explicitly from provider)
       - Configure reconnection: reconnectionDelay 1000, reconnectionDelayMax 30000, randomizationFactor 0.1
       - Client-side only (check typeof window)

    3. Create src/lib/socket/provider.tsx:
       - 'use client' directive
       - Create SocketContext with React.createContext
       - SocketProvider component:
         a. Creates socket instance on mount using getSocket()
         b. Connects the socket
         c. Tracks connection state: isConnected (boolean)
         d. Handles 'connect', 'disconnect', 'reconnect', 'reconnect_attempt' events
         e. On 'connect': emit 'request-state' (for future game state recovery — PITFALL 6)
         f. Cleanup: disconnect socket on unmount
       - Export useSocket() hook that returns { socket, isConnected }
       - Socket instance should be stable across re-renders (useRef)

    4. Create src/components/layout/connection-status.tsx:
       - 'use client' component
       - Uses useSocket() hook to get isConnected
       - Renders a small indicator dot:
         - Green dot + "Verbunden" when connected
         - Red/gray dot + "Getrennt" when disconnected
       - Styled to fit in the sidebar bottom area
       - Uses German translations from de.json (nav.connectionOnline, nav.connectionOffline)
       - Subtle animation on state change (fade or pulse)

    5. Update src/app/(app)/layout.tsx:
       - Wrap the main content area (and sidebar) with SocketProvider
       - SocketProvider should be inside the server component, wrapping the client components
       - Add ConnectionStatus component to the sidebar (pass down or render directly)

    CRITICAL PITFALLS:
    - Socket.IO auth middleware MUST verify the session cookie server-side (PITFALL 4)
    - On reconnect, emit 'request-state' to recover game state (PITFALL 6)
    - Use exponential backoff with jitter (PITFALL from research Pattern 5)
    - Socket connection should only happen for authenticated users (inside (app) layout)
  </action>
  <verify>
    1. `npm run build` passes
    2. Start dev server with `node server.js`, login, and check browser console for Socket.IO connection
    3. Connection status shows green "Verbunden" dot after login
    4. Disconnect network -> status changes to red "Getrennt"
    5. Reconnect network -> Socket.IO auto-reconnects, status returns to green
    6. Server console shows "Client connected: [userId]" on login
    7. Unauthenticated socket connection attempt is rejected (check server logs)
  </verify>
  <done>
    - Socket.IO server authenticates connections via session cookie
    - SocketProvider manages connection lifecycle in React
    - Connection status indicator shows real-time online/offline state in sidebar
    - Automatic reconnection with exponential backoff works
    - Unauthenticated WebSocket connections are rejected
    - State recovery request emitted on reconnect (stub for Phase 2)
  </done>
</task>

</tasks>

<verification>
1. Full flow: Login -> see sidebar with nav links -> lobby placeholder shows
2. Mobile: hamburger menu opens sidebar sheet, nav links work
3. WebSocket connects after authentication (green indicator)
4. Network interruption -> "Getrennt" indicator -> auto-reconnect -> "Verbunden"
5. Admin users see "Administration" link, regular users do not
6. Logout from user menu works
7. Server logs show authenticated socket connections
</verification>

<success_criteria>
- Authenticated users see app shell with sidebar navigation
- Lobby placeholder displays German "coming soon" message
- Sidebar is responsive (collapsible on mobile)
- WebSocket connects with auth and shows connection status
- Reconnection works automatically within 60 seconds
- Admin-only nav items are correctly guarded
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
