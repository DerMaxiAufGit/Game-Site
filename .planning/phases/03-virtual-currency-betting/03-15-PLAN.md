---
phase: 03-virtual-currency-betting
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/page.tsx
  - src/app/game/[roomId]/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User joining a bet room where betAmount > 25% of their balance sees a confirmation dialog before the join happens"
    - "User can cancel the confirmation dialog and NOT join the room"
    - "User confirming the dialog joins the room and navigates to it"
    - "Low-stakes bets (betAmount <= 25% of balance) join immediately without dialog"
    - "Free rooms (isBetRoom: false) join immediately without dialog"
  artifacts:
    - path: "src/app/(app)/page.tsx"
      provides: "BetConfirmation integration in lobby join flow"
      contains: "BetConfirmation"
    - path: "src/app/game/[roomId]/page.tsx"
      provides: "BetConfirmation integration for direct URL navigation to bet rooms"
      contains: "BetConfirmation"
  key_links:
    - from: "src/app/(app)/page.tsx"
      to: "src/components/betting/bet-confirmation.tsx"
      via: "import and render with open/onConfirm/onCancel props"
      pattern: "import.*BetConfirmation"
    - from: "src/app/(app)/page.tsx handleJoinRoom"
      to: "room:join socket emission"
      via: "threshold check gates emission behind confirmation dialog"
      pattern: "betAmount.*balance.*0\\.25"
    - from: "src/app/game/[roomId]/page.tsx"
      to: "src/components/betting/bet-confirmation.tsx"
      via: "import and render for direct URL join flow"
      pattern: "import.*BetConfirmation"
---

<objective>
Wire BetConfirmation component into room join flows so high-stakes bets (>25% of balance) show a confirmation dialog before placement.

Purpose: Close the last remaining Phase 3 verification gap (truth #5: "High-stakes bets show confirmation dialog before placement"). The BetConfirmation component exists with correct logic but is dead code — never imported or used.

Output: Both the lobby page and game room page integrate BetConfirmation, gating room:join emission behind user confirmation when the bet exceeds 25% of the user's balance.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-virtual-currency-betting/03-VERIFICATION.md

# Source files to modify
@src/app/(app)/page.tsx
@src/app/game/[roomId]/page.tsx

# Component to wire in (already complete, just needs importing)
@src/components/betting/bet-confirmation.tsx

# Type definitions (RoomInfo has isBetRoom, betAmount fields)
@src/types/game.ts

# Socket provider (useSocket exposes balance)
@src/lib/socket/provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire BetConfirmation into lobby page join flow</name>
  <files>src/app/(app)/page.tsx</files>
  <action>
    In the lobby page (src/app/(app)/page.tsx):

    1. Add import for BetConfirmation:
       `import { BetConfirmation } from '@/components/betting/bet-confirmation'`

    2. Destructure `balance` from useSocket() (line 18):
       `const { socket, isConnected, userId, balance } = useSocket()`

    3. Add state for pending join (after the activeFilter state, around line 23):
       ```
       const [pendingJoinRoom, setPendingJoinRoom] = useState<RoomInfo | null>(null)
       ```

    4. Modify `handleJoinRoom` (lines 57-70) to check the 25% threshold BEFORE emitting room:join:
       ```
       const handleJoinRoom = (roomId: string) => {
         if (!socket) {
           toast.error('Keine Verbindung zum Server')
           return
         }

         // Find the room to check bet amount
         const room = rooms.find(r => r.id === roomId)
         if (!room) return

         // Check if high-stakes confirmation needed
         const userBalance = balance ?? 0
         if (room.isBetRoom && room.betAmount > 0 && userBalance > 0 && room.betAmount > userBalance * 0.25) {
           setPendingJoinRoom(room)
           return
         }

         // Low-stakes or free room: join immediately
         doJoinRoom(roomId)
       }
       ```

    5. Extract the actual join logic into a separate function:
       ```
       const doJoinRoom = (roomId: string) => {
         if (!socket) return
         socket.emit('room:join', { roomId }, (response: { success: boolean; error?: string }) => {
           if (response.success) {
             router.push(`/game/${roomId}`)
           } else {
             toast.error(response.error || 'Fehler beim Beitreten')
           }
         })
       }
       ```

    6. Add confirmation and cancel handlers:
       ```
       const handleConfirmJoin = () => {
         if (pendingJoinRoom) {
           doJoinRoom(pendingJoinRoom.id)
           setPendingJoinRoom(null)
         }
       }

       const handleCancelJoin = () => {
         setPendingJoinRoom(null)
       }
       ```

    7. Render BetConfirmation dialog just before the closing `</div>` of the return statement (after the CreateRoomDialog):
       ```
       <BetConfirmation
         open={!!pendingJoinRoom}
         betAmount={pendingJoinRoom?.betAmount ?? 0}
         currentBalance={balance ?? 0}
         onConfirm={handleConfirmJoin}
         onCancel={handleCancelJoin}
       />
       ```

    IMPORTANT: The threshold check uses `room.betAmount > userBalance * 0.25` which matches the BetConfirmation component's own 25% threshold logic (line 29 of bet-confirmation.tsx). Free rooms (isBetRoom: false) and rooms where the bet is <= 25% of balance skip the dialog entirely.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` — no type errors
    2. Grep for "BetConfirmation" in src/app/(app)/page.tsx — found (import + render)
    3. Grep for "pendingJoinRoom" in src/app/(app)/page.tsx — found (state + handlers)
    4. Grep for "0.25" in src/app/(app)/page.tsx — found (threshold check)
  </verify>
  <done>
    Lobby page gates room:join behind BetConfirmation dialog when betAmount > 25% of user balance. Free rooms and low-stakes bets join immediately. Cancel closes dialog without joining.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire BetConfirmation into game room page for direct URL navigation</name>
  <files>src/app/game/[roomId]/page.tsx</files>
  <action>
    In the game room page (src/app/game/[roomId]/page.tsx):

    The game room page auto-joins via useEffect on mount (line 41). There are two scenarios:
    - User clicked "Join" in lobby (already confirmed if high-stakes) — navigated here after room:join succeeded
    - User navigates directly via URL (typed URL, bookmark, shared link) — no prior confirmation

    For direct URL navigation to bet rooms, we need to:
    1. NOT auto-join immediately
    2. First fetch room info to check if it's a high-stakes bet room
    3. Show confirmation if needed
    4. Join only after confirmation (or immediately if low-stakes/free)

    Implementation:

    1. Add import for BetConfirmation:
       `import { BetConfirmation } from '@/components/betting/bet-confirmation'`

    2. Destructure `balance` from useSocket() (line 29):
       `const { socket, isConnected, userId, balance } = useSocket()`

    3. Add state for confirmation flow (after gameEnd state, around line 35):
       ```
       const [showBetConfirm, setShowBetConfirm] = useState(false)
       const [pendingRoomInfo, setPendingRoomInfo] = useState<{ betAmount: number } | null>(null)
       const [joinConfirmed, setJoinConfirmed] = useState(false)
       ```

    4. Replace the current useEffect join logic (lines 37-98). The key change is: instead of immediately emitting room:join, first emit room:peek (or room:join with a gating mechanism). However, the server may not have a room:peek event. The simplest correct approach:

       Modify the useEffect to gate the room:join emission behind a confirmation check. Since we don't know the room's bet amount before joining, use a two-phase approach:

       a) Emit room:join as before (the server validates balance anyway)
       b) BUT intercept the room:update response to check if it's a high-stakes bet room

       Actually, the cleanest approach: the room:join callback on the lobby page already handles navigation. If the user arrives at the game room page, they EITHER:
       - Came from lobby (already confirmed) — safe to auto-join
       - Navigated directly — need to check

       Use a simpler pattern: emit room:join but ALSO check the first room:update. If the room is a high-stakes bet room and the user has NOT been through confirmation, show the dialog. But this has a race condition — the user is already joined.

       REVISED APPROACH (simplest and correct):

       The lobby page is the ONLY intentional join path. The game room page's room:join on mount is for state sync (re-joining an already-joined room or reconnecting). The server already handles duplicate joins idempotently (plan 03-13). So:

       - Keep the auto-join in useEffect as-is (for reconnection and normal flow from lobby)
       - Add a SEPARATE check: when room data first arrives via room:update, if the user is NOT yet a player or spectator (meaning this is a fresh direct URL visit to a bet room), AND the bet is high-stakes, show confirmation BEFORE the server processes the join fully

       Actually, the simplest correct approach that addresses the verification gap:

       Replace the auto-join useEffect to check balance threshold first. Use the rooms list or a pre-join info fetch. Since socket doesn't have room:peek, we'll use a different pattern:

       **Final approach — gate the auto-join with state:**

       ```typescript
       // In the useEffect, replace the direct socket.emit('room:join', { roomId }) with:

       // First, request room info without joining
       socket.emit('room:list', (response: { success: boolean; rooms?: RoomInfo[] }) => {
         if (response.success && response.rooms) {
           const targetRoom = response.rooms.find(r => r.id === roomId)
           if (targetRoom && targetRoom.isBetRoom && targetRoom.betAmount > 0) {
             const userBalance = balance ?? 0
             if (userBalance > 0 && targetRoom.betAmount > userBalance * 0.25) {
               // High-stakes: show confirmation before joining
               setPendingRoomInfo({ betAmount: targetRoom.betAmount })
               setShowBetConfirm(true)
               return
             }
           }
         }
         // Low-stakes, free room, or room not found in list: join directly
         socket.emit('room:join', { roomId })
       })
       ```

       Then add a separate useEffect to handle the confirmed join:
       ```typescript
       useEffect(() => {
         if (joinConfirmed && socket && isConnected) {
           socket.emit('room:join', { roomId })
           setJoinConfirmed(false)
         }
       }, [joinConfirmed, socket, isConnected, roomId])
       ```

       Add confirmation handlers:
       ```typescript
       const handleBetConfirm = () => {
         setShowBetConfirm(false)
         setPendingRoomInfo(null)
         setJoinConfirmed(true)
       }

       const handleBetCancel = () => {
         setShowBetConfirm(false)
         setPendingRoomInfo(null)
         router.push('/')
       }
       ```

       Add the BetConfirmation component render in the JSX. Place it BEFORE the early returns for loading/error/etc., or render it conditionally when `showBetConfirm` is true. Best place: add a conditional return early in the render:

       ```typescript
       // After the "Room not loaded yet" block and before the game ended block:
       // Actually, render it alongside the loading state since the room hasn't loaded yet

       if (showBetConfirm && pendingRoomInfo) {
         return (
           <div className="flex h-screen items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
             <BetConfirmation
               open={true}
               betAmount={pendingRoomInfo.betAmount}
               currentBalance={balance ?? 0}
               onConfirm={handleBetConfirm}
               onCancel={handleBetCancel}
             />
           </div>
         )
       }
       ```

       Place this block right after the `if (!room)` loading block and before the `if (gameEnd || room.status === 'ended')` block.

    IMPORTANT: Also add `RoomInfo` to the import from '@/types/game' (line 8) since it's used in the room:list callback type.

    NOTE: If socket events set up in the useEffect fire before the join (like room:update), they just won't trigger until the join actually happens, so the event listeners can remain in the same useEffect — they're harmless before join.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` — no type errors
    2. Grep for "BetConfirmation" in src/app/game/[roomId]/page.tsx — found (import + render)
    3. Grep for "showBetConfirm" in src/app/game/[roomId]/page.tsx — found
    4. Grep for "0.25" in src/app/game/[roomId]/page.tsx — found (threshold check)
    5. Grep for "room:list" in src/app/game/[roomId]/page.tsx — found (pre-join info fetch)
  </verify>
  <done>
    Game room page checks bet threshold before auto-joining on direct URL navigation. High-stakes rooms show BetConfirmation dialog. Confirming proceeds with join, cancelling returns to lobby. Normal flow from lobby (post-confirmation) still works because the room:list check finds it's already a valid room and checks threshold.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. BetConfirmation is imported and rendered in BOTH:
   - src/app/(app)/page.tsx (lobby)
   - src/app/game/[roomId]/page.tsx (game room)
3. The 25% threshold check (`betAmount > balance * 0.25`) exists in both files
4. Free rooms (isBetRoom: false) bypass confirmation entirely
5. Low-stakes bet rooms (betAmount <= 25% of balance) bypass confirmation
6. Cancelling confirmation in lobby keeps user on lobby page
7. Cancelling confirmation in game room redirects to lobby
8. Confirming in lobby emits room:join and navigates to game room
9. Confirming in game room emits room:join and loads the room
10. src/components/betting/bet-confirmation.tsx is NO LONGER dead code
</verification>

<success_criteria>
- VERIFICATION.md truth #5 ("High-stakes bets show confirmation dialog before placement") passes
- BetConfirmation component is imported in 2 files (no longer dead code)
- Phase 3 score moves from 6/7 to 7/7
- All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-15-SUMMARY.md`
</output>
