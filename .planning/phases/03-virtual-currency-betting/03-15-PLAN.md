---
phase: 03-virtual-currency-betting
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(app)/page.tsx
  - src/app/game/[roomId]/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User joining a bet room where betAmount > 25% of their balance sees a confirmation dialog before the join happens"
    - "User can cancel the confirmation dialog and NOT join the room"
    - "User confirming the dialog joins the room and navigates to it"
    - "Low-stakes bets (betAmount <= 25% of balance) join immediately without dialog"
    - "Free rooms (isBetRoom: false) join immediately without dialog"
    - "User who confirmed in the lobby does NOT see a second confirmation on the game room page"
  artifacts:
    - path: "src/app/(app)/page.tsx"
      provides: "BetConfirmation integration in lobby join flow"
      contains: "BetConfirmation"
    - path: "src/app/game/[roomId]/page.tsx"
      provides: "BetConfirmation integration for direct URL navigation to bet rooms"
      contains: "BetConfirmation"
  key_links:
    - from: "src/app/(app)/page.tsx"
      to: "src/components/betting/bet-confirmation.tsx"
      via: "import and render with open/onConfirm/onCancel props"
      pattern: "import.*BetConfirmation.*from.*bet-confirmation"
    - from: "src/app/(app)/page.tsx handleJoinRoom"
      to: "room:join socket emission"
      via: "threshold check gates emission behind confirmation dialog"
      pattern: "room\\.betAmount\\s*>\\s*userBalance\\s*\\*\\s*0\\.25"
    - from: "src/app/game/[roomId]/page.tsx"
      to: "src/components/betting/bet-confirmation.tsx"
      via: "import and render for direct URL join flow"
      pattern: "import.*BetConfirmation.*from.*bet-confirmation"
    - from: "src/app/(app)/page.tsx doJoinRoom"
      to: "game room page ?confirmed=true"
      via: "lobby appends confirmed param when navigating after room:join"
      pattern: "router\\.push.*\\?confirmed=true"
---

<objective>
Wire BetConfirmation component into room join flows so high-stakes bets (>25% of balance) show a confirmation dialog before placement.

Purpose: Close the last remaining Phase 3 verification gap (truth #5: "High-stakes bets show confirmation dialog before placement"). The BetConfirmation component exists with correct logic but is dead code -- never imported or used.

Output: Both the lobby page and game room page integrate BetConfirmation, gating room:join emission behind user confirmation when the bet exceeds 25% of the user's balance. Lobby-to-game navigation passes `?confirmed=true` to avoid double confirmation.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-virtual-currency-betting/03-VERIFICATION.md

# Source files to modify
@src/app/(app)/page.tsx
@src/app/game/[roomId]/page.tsx

# Component to wire in (already complete, just needs importing)
@src/components/betting/bet-confirmation.tsx

# Type definitions (RoomInfo has isBetRoom, betAmount fields)
@src/types/game.ts

# Socket provider (useSocket exposes balance)
@src/lib/socket/provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire BetConfirmation into lobby page join flow</name>
  <files>src/app/(app)/page.tsx</files>
  <action>
    In the lobby page (src/app/(app)/page.tsx):

    1. Add import for BetConfirmation:
       `import { BetConfirmation } from '@/components/betting/bet-confirmation'`

    2. Destructure `balance` from useSocket() (line 18):
       `const { socket, isConnected, userId, balance } = useSocket()`

    3. Add state for pending join (after the activeFilter state, around line 23):
       ```
       const [pendingJoinRoom, setPendingJoinRoom] = useState<RoomInfo | null>(null)
       ```

    4. Extract the actual join logic into a separate function (BEFORE handleJoinRoom):
       ```
       const doJoinRoom = (roomId: string) => {
         if (!socket) return
         socket.emit('room:join', { roomId }, (response: { success: boolean; error?: string }) => {
           if (response.success) {
             router.push(`/game/${roomId}?confirmed=true`)
           } else {
             toast.error(response.error || 'Fehler beim Beitreten')
           }
         })
       }
       ```
       CRITICAL: The `?confirmed=true` query param tells the game room page that the user already went through the lobby flow. This prevents double confirmation (see Task 2).

    5. Replace `handleJoinRoom` (lines 57-70) to check the 25% threshold BEFORE emitting room:join:
       ```
       const handleJoinRoom = (roomId: string) => {
         if (!socket) {
           toast.error('Keine Verbindung zum Server')
           return
         }

         const room = rooms.find(r => r.id === roomId)
         if (!room) return

         const userBalance = balance ?? 0
         if (room.isBetRoom && room.betAmount > 0 && userBalance > 0 && room.betAmount > userBalance * 0.25) {
           setPendingJoinRoom(room)
           return
         }

         doJoinRoom(roomId)
       }
       ```

    6. Add confirmation and cancel handlers:
       ```
       const handleConfirmJoin = () => {
         if (pendingJoinRoom) {
           doJoinRoom(pendingJoinRoom.id)
           setPendingJoinRoom(null)
         }
       }

       const handleCancelJoin = () => {
         setPendingJoinRoom(null)
       }
       ```

    7. Render BetConfirmation dialog just before the closing `</div>` of the return statement (after the CreateRoomDialog):
       ```
       <BetConfirmation
         open={!!pendingJoinRoom}
         betAmount={pendingJoinRoom?.betAmount ?? 0}
         currentBalance={balance ?? 0}
         onConfirm={handleConfirmJoin}
         onCancel={handleCancelJoin}
       />
       ```

    IMPORTANT: The threshold check uses `room.betAmount > userBalance * 0.25` which matches the BetConfirmation component's own 25% threshold logic (line 29 of bet-confirmation.tsx). Free rooms (isBetRoom: false) and rooms where the bet is <= 25% of balance skip the dialog entirely.
  </action>
  <verify>
    1. `npx tsc --noEmit` -- no type errors
    2. Grep confirms import: `import { BetConfirmation } from '@/components/betting/bet-confirmation'` exists in page.tsx
    3. Grep confirms threshold gating: pattern `room\.betAmount > userBalance \* 0\.25` exists in page.tsx
    4. Grep confirms state: `pendingJoinRoom.*useState.*RoomInfo` exists in page.tsx
    5. Grep confirms confirmed param: `\?confirmed=true` exists in page.tsx (in doJoinRoom's router.push)
    6. Grep confirms BetConfirmation render: `<BetConfirmation` exists in page.tsx
  </verify>
  <done>
    Lobby page gates room:join behind BetConfirmation dialog when betAmount > 25% of user balance. Free rooms and low-stakes bets join immediately. Cancel closes dialog without joining. On confirm, navigates to game room with `?confirmed=true` to prevent double-prompting.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire BetConfirmation into game room page for direct URL navigation</name>
  <files>src/app/game/[roomId]/page.tsx</files>
  <action>
    In the game room page (src/app/game/[roomId]/page.tsx):

    There are two entry paths to this page:
    - **From lobby:** User already confirmed (if high-stakes) in the lobby. The lobby navigates with `?confirmed=true`. No second confirmation needed.
    - **Direct URL:** User typed URL, used bookmark, or clicked a shared link. No prior confirmation happened. Must show BetConfirmation for high-stakes rooms.

    Implementation (minimal state -- just 1 state var):

    1. Add imports:
       - `import { useSearchParams } from 'next/navigation'`
       - `import { BetConfirmation } from '@/components/betting/bet-confirmation'`

    2. Destructure `balance` from useSocket() (line 29):
       `const { socket, isConnected, userId, balance } = useSocket()`

    3. Add `useSearchParams` hook (after `const roomId = ...`, around line 32):
       `const searchParams = useSearchParams()`

    4. Add one state variable for the pending bet amount (after gameEnd state, around line 35):
       ```
       const [pendingBetAmount, setPendingBetAmount] = useState<number | null>(null)
       ```

    5. Modify the useEffect (lines 37-98). Replace the `socket.emit('room:join', { roomId })` on line 41 with a gated approach:
       ```
       // Check if user already confirmed in lobby
       const alreadyConfirmed = searchParams.get('confirmed') === 'true'

       if (alreadyConfirmed) {
         // From lobby -- join directly, confirmation already happened
         socket.emit('room:join', { roomId })
       } else {
         // Direct URL -- check if high-stakes confirmation needed
         socket.emit('room:list', (response: { success: boolean; rooms?: RoomInfo[] }) => {
           if (response.success && response.rooms) {
             const targetRoom = response.rooms.find(r => r.id === roomId)
             const userBalance = balance ?? 0
             if (targetRoom && targetRoom.isBetRoom && targetRoom.betAmount > 0 && userBalance > 0 && targetRoom.betAmount > userBalance * 0.25) {
               setPendingBetAmount(targetRoom.betAmount)
               return
             }
           }
           // Low-stakes, free room, or not found: join directly
           socket.emit('room:join', { roomId })
         })
       }
       ```
       Add `searchParams` and `balance` to the useEffect dependency array: `[socket, isConnected, roomId, router, searchParams, balance]`

       Keep ALL existing event listeners (room:update, room:player-joined, etc.) and cleanup logic UNCHANGED. They are harmless before the join happens and will fire correctly after it.

    6. Add confirmation handlers (before the render/return statements):
       ```
       const handleBetConfirm = () => {
         setPendingBetAmount(null)
         if (socket) socket.emit('room:join', { roomId })
       }

       const handleBetCancel = () => {
         setPendingBetAmount(null)
         router.push('/')
       }
       ```

    7. Add a conditional render block for the confirmation dialog. Place it AFTER the `if (!room)` loading block (line 127-136) and BEFORE the `if (gameEnd || room.status === 'ended')` block (line 139):
       ```
       // High-stakes bet confirmation for direct URL navigation
       if (pendingBetAmount !== null) {
         return (
           <div className="flex h-screen items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
             <BetConfirmation
               open={true}
               betAmount={pendingBetAmount}
               currentBalance={balance ?? 0}
               onConfirm={handleBetConfirm}
               onCancel={handleBetCancel}
             />
           </div>
         )
       }
       ```

    NOTE: RoomInfo is already imported on line 8 (`import type { GameState, RoomInfo } from '@/types/game'`), so no additional type import needed.
  </action>
  <verify>
    1. `npx tsc --noEmit` -- no type errors
    2. Grep confirms import: `import { BetConfirmation } from '@/components/betting/bet-confirmation'` exists in page.tsx
    3. Grep confirms searchParams: `searchParams\.get.*confirmed` exists in page.tsx
    4. Grep confirms threshold: `betAmount > userBalance \* 0\.25` exists in page.tsx
    5. Grep confirms single state var: `pendingBetAmount.*useState` exists in page.tsx
    6. Grep confirms BetConfirmation render: `<BetConfirmation` exists in page.tsx
    7. Grep confirms cancel navigates home: `handleBetCancel.*router\.push.*'/'` pattern exists
  </verify>
  <done>
    Game room page differentiates lobby navigation (with `?confirmed=true`) from direct URL visits. Lobby users skip confirmation. Direct URL visitors see BetConfirmation for high-stakes rooms. Confirming emits room:join, cancelling returns to lobby. Only 1 new state variable -- no excessive complexity.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. BetConfirmation is imported and rendered in BOTH:
   - src/app/(app)/page.tsx (lobby)
   - src/app/game/[roomId]/page.tsx (game room)
3. The 25% threshold check (`betAmount > userBalance * 0.25`) exists in both files
4. Free rooms (isBetRoom: false) bypass confirmation entirely
5. Low-stakes bet rooms (betAmount <= 25% of balance) bypass confirmation
6. Cancelling confirmation in lobby keeps user on lobby page
7. Cancelling confirmation in game room redirects to lobby
8. Confirming in lobby emits room:join and navigates to game room with `?confirmed=true`
9. Confirming in game room emits room:join and loads the room
10. Lobby-to-game flow does NOT show double confirmation (confirmed param skips dialog)
11. Direct URL to high-stakes room DOES show confirmation
12. src/components/betting/bet-confirmation.tsx is NO LONGER dead code
</verification>

<success_criteria>
- VERIFICATION.md truth #5 ("High-stakes bets show confirmation dialog before placement") passes
- BetConfirmation component is imported in 2 files (no longer dead code)
- Phase 3 score moves from 6/7 to 7/7
- All TypeScript compilation passes
- No double confirmation for lobby-to-game flow
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-15-SUMMARY.md`
</output>
