---
phase: 03-virtual-currency-betting
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/actions/admin-finance.ts
  - src/components/admin/transaction-log.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Admin finance page loads without hydration errors"
    - "All 5 tabs render including Einstellungen"
    - "Transaction dates display correctly in German format"
    - "Suspicious activity timestamps display correctly"
  artifacts:
    - path: "src/lib/actions/admin-finance.ts"
      provides: "Serialized date strings in transaction log and alerts"
    - path: "src/components/admin/transaction-log.tsx"
      provides: "Transaction interface with string dates"
  key_links:
    - from: "src/app/(app)/admin/finance/page.tsx"
      to: "src/lib/actions/admin-finance.ts"
      via: "getAdminTransactionLog returns serialized data"
      pattern: "getAdminTransactionLog"
    - from: "src/components/admin/transaction-log.tsx"
      to: "formatDate"
      via: "Formats ISO string dates to de-DE display"
      pattern: "formatDate"
---

<objective>
Fix hydration mismatch error on admin finance page that prevents all tabs from rendering, including the Einstellungen tab.

Purpose: Unblock 5 skipped UAT tests that depend on admin finance page working (transaction log, balance adjustment, wallet freeze, alerts, system settings).
Output: Working admin finance page with all 5 tabs rendering correctly.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/actions/admin-finance.ts
@src/components/admin/transaction-log.tsx
@src/app/(app)/admin/finance/page.tsx
@src/components/admin/alert-monitor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Serialize dates in admin-finance server actions</name>
  <files>src/lib/actions/admin-finance.ts</files>
  <action>
The hydration error is caused by Date objects from Prisma being passed to client components. `Intl.DateTimeFormat` produces different output on server vs client due to timezone/locale differences.

**Fix getAdminTransactionLog() (lines 131-187):**

The function returns `transactions` with Prisma Date objects. Serialize dates to ISO strings before returning. Change the return to map transactions:

```typescript
return {
  transactions: items.map((item) => ({
    ...item,
    createdAt: item.createdAt.toISOString(),
  })),
  nextCursor,
}
```

**Fix getSuspiciousActivity() (lines 690-842):**

This function returns `SuspiciousAlert[]` where `timestamp` is a `Date`. The AlertMonitor component calls this client-side via server action (not passed as prop from page), so dates get serialized during the server action boundary. However, to be safe and consistent, also serialize timestamps:

Update the `SuspiciousAlert` interface (line 678-685):
```typescript
interface SuspiciousAlert {
  type: 'large_transfer' | 'daily_limit' | 'balance_drop'
  severity: 'warning' | 'critical'
  userId: string
  displayName: string
  details: string
  timestamp: string  // Changed from Date to string
}
```

Update all places in `getSuspiciousActivity()` where `timestamp` is set:
- Line 731: `timestamp: tx.createdAt.toISOString(),`
- Line 763: `timestamp: new Date().toISOString(),`
- Line 832: `timestamp: new Date().toISOString(),`

Update the sort at line 839:
```typescript
alerts.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())
```

**Fix getUsersWithWallets() (line 632-676):**

The `frozenAt` field returned at line 674 is also a Date. Serialize it:
```typescript
return users.map((user) => ({
  userId: user.id,
  displayName: user.displayName,
  username: user.username,
  email: user.email,
  balance: user.wallet?.balance || 0,
  frozenAt: user.wallet?.frozenAt?.toISOString() || null,
}))
```

**Fix getSystemSettings() (lines 192-206):**

The settings object from Prisma contains `createdAt` and `updatedAt` Date fields. The `EconomicSettings` component receives this as a prop from the server page component. The component interface (economic-settings.tsx line 19-32) does NOT include date fields, only the config fields -- so this should be fine as long as only the listed fields are used. But to be safe, spread only the needed fields:

Actually, looking at the EconomicSettings interface, it only has config fields (no dates), so Prisma's extra date fields on the settings object should just be ignored by the client component. No change needed here.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors after the interface changes.
  </verify>
  <done>
All Date objects from admin-finance server actions are serialized to ISO strings before reaching client components. No hydration mismatch between server and client rendering.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update client components to use string dates</name>
  <files>src/components/admin/transaction-log.tsx, src/components/admin/alert-monitor.tsx</files>
  <action>
**Update TransactionLog (transaction-log.tsx):**

1. Change the `Transaction` interface (line 30-47) to use `string` for `createdAt`:
```typescript
interface Transaction {
  id: string
  userId: string
  type: string
  amount: number
  description: string | null
  createdAt: string  // Changed from Date to string
  user: {
    id: string
    displayName: string
    username: string
  }
  relatedUser: {
    id: string
    displayName: string
    username: string
  } | null
}
```

2. Update the `formatDate` function (lines 76-84) to accept a string:
```typescript
const formatDate = (date: string) => {
  return new Intl.DateTimeFormat('de-DE', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date))
}
```

The actual usage at line 247 `{formatDate(transaction.createdAt)}` stays the same since `formatDate` now accepts a string.

**Update AlertMonitor (alert-monitor.tsx):**

1. Change the `SuspiciousAlert` interface (line 18-25) to use `string` for `timestamp`:
```typescript
interface SuspiciousAlert {
  type: 'large_transfer' | 'daily_limit' | 'balance_drop'
  severity: 'warning' | 'critical'
  userId: string
  displayName: string
  details: string
  timestamp: string  // Changed from Date to string
}
```

2. The usage at line 190 already wraps in `new Date()`:
```typescript
{formatDistanceToNow(new Date(alert.timestamp), { addSuffix: true, locale: de })}
```
This already works with both Date and string inputs, so no change needed at usage site.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no TypeScript errors. Then start dev server with `npm run dev`, navigate to `/admin/finance` in a browser, and confirm:
1. No hydration error in console
2. All 5 tabs visible: Dashboard, Transaktionen, Guthaben, Alarme, Einstellungen
3. Transaction dates display in German format (DD.MM.YYYY HH:MM)
4. Clicking the Einstellungen tab shows the economic settings form
  </verify>
  <done>
Admin finance page renders without hydration errors. All 5 tabs are visible and functional. Transaction dates display correctly. The Einstellungen tab is accessible (Gap 4 resolved as consequence of fixing Gap 3).
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin/finance -- page loads without console errors
2. All 5 tabs render: Dashboard, Transaktionen, Guthaben, Alarme, Einstellungen
3. Transaction dates in the log display in DD.MM.YYYY HH:MM format
4. Einstellungen tab shows the economic settings form with all fields
5. No hydration mismatch warnings in browser console
</verification>

<success_criteria>
Admin finance page loads cleanly with all 5 tabs visible. Einstellungen tab accessible. Transaction dates formatted correctly. 5 previously-skipped UAT tests unblocked (admin transaction log, balance adjustment, wallet freeze, alerts, system settings).
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-12-SUMMARY.md`
</output>
