---
phase: 03-virtual-currency-betting
plan: 14
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/game/[roomId]/page.tsx
  - src/components/game/WaitingRoom.tsx
  - src/components/admin/economic-settings.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Pot display shows correct total during gameplay in bet rooms"
    - "TransferDialog with Chips senden button is accessible from WaitingRoom player list"
    - "TransferDialog with player list is accessible from ended phase results screen"
    - "Admin settings save works without JSON parse error for bet presets"
  artifacts:
    - path: "src/app/game/[roomId]/page.tsx"
      provides: "GameBoard with isBetRoom and betAmount props, ended phase with TransferDialog"
      contains: "isBetRoom.*betAmount|TransferDialog"
    - path: "src/components/game/WaitingRoom.tsx"
      provides: "Transfer button per player in waiting room"
      contains: "TransferDialog"
    - path: "src/components/admin/economic-settings.tsx"
      provides: "Fixed form with no duplicate name attribute on bet presets"
  key_links:
    - from: "page.tsx GameBoard render"
      to: "GameBoard isBetRoom prop"
      via: "room.isBetRoom and room.betAmount passed as props"
      pattern: "isBetRoom=.room\\.isBetRoom."
    - from: "WaitingRoom player list"
      to: "TransferDialog component"
      via: "import and render per player"
      pattern: "TransferDialog.*recipientId"
    - from: "economic-settings.tsx visible Input"
      to: "hidden input name=defaultBetPresets"
      via: "only hidden input has name attribute"
      pattern: "type=\"hidden\".*name=\"defaultBetPresets\""
---

<objective>
Fix three client-side bugs discovered during UAT round 2: (1) pot display not showing during gameplay because GameBoard missing props, (2) player card transfer button unreachable in WaitingRoom and ended phase, (3) admin settings save fails due to duplicate form field name.

Purpose: Without these fixes, bet room players cannot see the pot amount during games, chip transfers between players are impossible in waiting/ended phases, and admins cannot save economy settings.

Output: Patched page.tsx, WaitingRoom.tsx, and economic-settings.tsx with correct prop passing, TransferDialog integration, and form field fix.
</objective>

<execution_context>
@C:\Users\maxi\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\maxi\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-virtual-currency-betting/03-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pass bet props to GameBoard and add TransferDialog to WaitingRoom and ended phase</name>
  <files>src/app/game/[roomId]/page.tsx, src/components/game/WaitingRoom.tsx</files>
  <action>
  Three UI fixes across two files:

  **A) Fix GameBoard props in page.tsx (Gap 2):**
  In `src/app/game/[roomId]/page.tsx`, the GameBoard render at line 218 is missing `isBetRoom` and `betAmount`:
  ```jsx
  // BEFORE (line 216-225):
  if (room.status === 'playing' && room.gameState) {
    return (
      <GameBoard
        gameState={room.gameState}
        roomId={roomId}
        currentUserId={userId || ''}
        hostId={room.hostId}
        socket={socket}
      />
    )
  }

  // AFTER:
  if (room.status === 'playing' && room.gameState) {
    return (
      <GameBoard
        gameState={room.gameState}
        roomId={roomId}
        currentUserId={userId || ''}
        hostId={room.hostId}
        socket={socket}
        isBetRoom={room.isBetRoom ?? false}
        betAmount={room.betAmount ?? 0}
      />
    )
  }
  ```

  Also update the `RoomData` interface at line 14 to include bet fields:
  ```typescript
  interface RoomData extends RoomInfo {
    players: { userId: string; displayName: string; isReady: boolean }[]
    spectators: string[]
    gameState?: GameState
    isBetRoom?: boolean
    betAmount?: number
  }
  ```

  **B) Add TransferDialog to ended phase in page.tsx (Gap 4):**
  In the game ended section (line 138-203), add TransferDialog buttons next to each player. Import TransferDialog at the top of the file:
  ```typescript
  import { TransferDialog } from '@/components/wallet/transfer-dialog'
  import { Send } from 'lucide-react'
  ```

  In the ended phase render, add a "Chips senden" button next to each player (except self) within the sorted player list map. After the score span (line 184), before the closing `</div>` of each player row:
  ```jsx
  {!isMe && (
    <TransferDialog
      recipientId={player.userId}
      recipientName={player.displayName}
      trigger={
        <Button
          size="sm"
          variant="ghost"
          className="h-8 px-2 hover:bg-green-600/20 hover:text-green-400 text-gray-400"
        >
          <Send className="h-3 w-3 mr-1" />
          Chips senden
        </Button>
      }
    />
  )}
  ```

  Adjust the player row layout so the score and transfer button are grouped on the right side using a flex container:
  ```jsx
  <div className="flex items-center gap-2">
    <span className={`text-xl font-bold ${isWinner ? 'text-yellow-300' : 'text-gray-300'}`}>
      {player.total}
    </span>
    {!isMe && (
      <TransferDialog ... />
    )}
  </div>
  ```

  **C) Add TransferDialog to WaitingRoom player list (Gap 4):**
  In `src/components/game/WaitingRoom.tsx`, the inline player list at lines 155-195 does not include TransferDialog. Add it.

  Import at the top:
  ```typescript
  import { TransferDialog } from '@/components/wallet/transfer-dialog'
  import { Send } from 'lucide-react'
  ```

  Add `isBetRoom` and `betAmount` to the `RoomData` interface:
  ```typescript
  interface RoomData {
    // ... existing fields
    isBetRoom?: boolean
    betAmount?: number
  }
  ```

  In each player row (line 157-194), after the host kick button section, add a TransferDialog for non-self, non-host-action players:
  ```jsx
  <div className="flex items-center gap-2">
    {/* Existing host kick button */}
    {isHost && player.userId !== room.hostId && (
      <Button variant="destructive" size="sm" onClick={() => handleKickPlayer(player.userId)}>
        {t('room.kickPlayer')}
      </Button>
    )}
    {/* Transfer button for other players */}
    {player.userId !== currentUserId && (
      <TransferDialog
        recipientId={player.userId}
        recipientName={player.displayName}
        trigger={
          <Button
            size="sm"
            variant="ghost"
            className="h-8 px-2 hover:bg-green-600/20 hover:text-green-400 text-gray-400"
          >
            <Send className="h-3 w-3 mr-1" />
            Chips senden
          </Button>
        }
      />
    )}
  </div>
  ```

  Also display bet room info in the room settings grid if it is a bet room:
  ```jsx
  {room.isBetRoom && (
    <>
      <div>
        <p className="text-xs text-gray-400">Einsatz</p>
        <p className="text-lg font-semibold text-amber-400">{room.betAmount} Chips</p>
      </div>
    </>
  )}
  ```
  </action>
  <verify>
  1. `npx tsc --noEmit` passes with no errors
  2. Grep page.tsx for `isBetRoom={room.isBetRoom` confirms prop passing
  3. Grep page.tsx for `TransferDialog` confirms it exists in ended phase
  4. Grep WaitingRoom.tsx for `TransferDialog` confirms it exists in player list
  </verify>
  <done>
  - GameBoard receives isBetRoom and betAmount from room data, enabling PotDisplay
  - WaitingRoom shows "Chips senden" button per player (except self) via TransferDialog
  - Ended phase shows "Chips senden" button per player (except self) via TransferDialog
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix duplicate name attribute on admin settings bet presets input</name>
  <files>src/components/admin/economic-settings.tsx</files>
  <action>
  **Fix the duplicate name='defaultBetPresets' (Gap 5):**
  In `src/components/admin/economic-settings.tsx`, line 239-240 has a visible Input with `name="defaultBetPresets"` AND line 247-256 has a hidden input with the same name. When the form submits, `FormData.get('defaultBetPresets')` returns the FIRST match (the comma-separated string from the visible input), not the JSON from the hidden input.

  Fix: Remove the `name` attribute from the visible Input at line 239-240. The visible input is for user display only; the hidden input carries the properly formatted JSON value.

  Change line 238-246 from:
  ```jsx
  <Input
    id="defaultBetPresets"
    name="defaultBetPresets"
    value={betPresets}
    onChange={(e) => setBetPresets(e.target.value)}
    placeholder="z.B. 10, 25, 50, 100"
    required
    className="bg-zinc-800 border-white/10 text-white"
  />
  ```

  To (remove `name` and `required` from visible input since hidden input carries the data):
  ```jsx
  <Input
    id="defaultBetPresets"
    value={betPresets}
    onChange={(e) => setBetPresets(e.target.value)}
    placeholder="z.B. 10, 25, 50, 100"
    className="bg-zinc-800 border-white/10 text-white"
  />
  ```

  The hidden input at line 247 already has `name="defaultBetPresets"` and `value={JSON.stringify(...)}`, so it will now be the only source for the form data.
  </action>
  <verify>
  1. `npx tsc --noEmit` passes
  2. Grep economic-settings.tsx for `name="defaultBetPresets"` returns exactly 1 match (the hidden input only)
  3. Confirm the visible Input no longer has `name` or `required` attributes
  </verify>
  <done>
  - Only one input with name="defaultBetPresets" exists (the hidden one with JSON value)
  - FormData.get('defaultBetPresets') returns properly formatted JSON array
  - Admin settings form saves successfully
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no TypeScript errors across all modified files
2. GameBoard receives isBetRoom/betAmount props from page.tsx
3. WaitingRoom renders TransferDialog per player
4. Ended phase renders TransferDialog per player
5. Admin settings form has exactly one `name="defaultBetPresets"` input (the hidden one)
</verification>

<success_criteria>
- Pot display shows during gameplay in bet rooms (PotDisplay component receives non-zero values)
- TransferDialog accessible from both WaitingRoom and ended phase player lists
- Admin economy settings save without JSON parse error
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-14-SUMMARY.md`
</output>
