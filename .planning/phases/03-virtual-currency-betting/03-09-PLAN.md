---
phase: 03-virtual-currency-betting
plan: 09
type: execute
wave: 4
depends_on: ["03-05", "03-08"]
files_modified:
  - src/components/admin/balance-adjust.tsx
  - src/components/admin/alert-monitor.tsx
  - src/app/(app)/admin/finance/page.tsx
  - src/lib/actions/admin-finance.ts
  - src/components/admin/invite-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can adjust a single user's balance with optional reason"
    - "Admin can bulk adjust multiple users or all users at once"
    - "Admin can freeze a user's wallet (blocks outbound but allows inbound)"
    - "Suspicious activity alerts show in admin finance dashboard"
    - "All admin balance changes are logged in transaction history"
    - "Admin can override starting balance when inviting a new user"
    - "Affected users get updated balance on next page load or socket interaction after admin adjustment"
  artifacts:
    - path: "src/components/admin/balance-adjust.tsx"
      provides: "Single and bulk balance adjustment UI with user selection and reason field"
      exports: ["BalanceAdjust"]
    - path: "src/components/admin/alert-monitor.tsx"
      provides: "Suspicious activity alert display with configurable thresholds"
      exports: ["AlertMonitor"]
    - path: "src/app/(app)/admin/finance/page.tsx"
      provides: "Updated finance page with balance tools and alerts sections"
      contains: "BalanceAdjust"
    - path: "src/components/admin/invite-dialog.tsx"
      provides: "Updated invite dialog with optional custom starting balance field"
      contains: "startingBalance"
  key_links:
    - from: "src/components/admin/balance-adjust.tsx"
      to: "src/lib/actions/admin-finance.ts"
      via: "adjustUserBalance and bulkAdjustBalance server actions"
      pattern: "(adjustUserBalance|bulkAdjustBalance)"
    - from: "src/components/admin/alert-monitor.tsx"
      to: "src/lib/actions/admin-finance.ts"
      via: "getSuspiciousActivity server action"
      pattern: "getSuspiciousActivity"
    - from: "src/components/admin/invite-dialog.tsx"
      to: "src/lib/actions/admin.ts"
      via: "createInvite server action with optional customStartingBalance"
      pattern: "customStartingBalance"
    - from: "server.js"
      to: "user balance"
      via: "balance:updated event emitted after admin adjustment OR user fetches on next socket interaction"
      pattern: "balance:updated"
---

<objective>
Admin balance management tools (single/bulk adjustments, freeze), suspicious activity alerts, custom starting balance on invite, and real-time balance notification for affected users.

Purpose: Per user decisions, admin needs granular balance control with adjustments (single/bulk), wallet freeze capability, and configurable alerts for suspicious patterns. Additionally, per GUTH-01, admin must be able to override the starting balance when inviting a new user. Admin balance adjustments should notify affected users so their balance updates promptly.

Output: Balance adjustment UI, wallet freeze/unfreeze, suspicious activity alert monitor, updated invite dialog with custom starting balance field, all integrated into admin finance page.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-05-SUMMARY.md
@src/lib/actions/admin-finance.ts
@src/lib/actions/admin.ts
@src/app/(app)/admin/finance/page.tsx
@src/components/admin/invite-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Suspicious activity detection, alert server actions, and invite starting balance override</name>
  <files>src/lib/actions/admin-finance.ts, src/lib/actions/admin.ts, src/components/admin/invite-dialog.tsx</files>
  <action>
Add to existing `src/lib/actions/admin-finance.ts`:

1. `getSuspiciousActivity()`:
   - requireAdmin()
   - Fetch SystemSettings for alert thresholds (alertTransferLimit, alertBalanceDropPct)
   - Run 3 alert queries in parallel:
     a. **Large transfers**: Transactions of type TRANSFER_SENT in last 24h where amount > alertTransferLimit. Include user displayName.
     b. **Daily transfer limit exceeded**: Group TRANSFER_SENT by userId in last 24h, sum amounts, find where sum > transferDailyLimit. Include user displayName and total.
     c. **Rapid balance drops**: Compare each user's current balance to their balance 1 hour ago (derive from transaction history). Flag where drop > alertBalanceDropPct % of balance. Include user displayName, previous balance, current balance, drop percentage.
   - Return structured alerts array: { type: 'large_transfer' | 'daily_limit' | 'balance_drop', severity: 'warning' | 'critical', userId, displayName, details, timestamp }
   - Sort by timestamp desc

2. `getUsersWithWallets(search?: string)`:
   - requireAdmin()
   - Fetch users with wallet info (balance, frozenAt)
   - If search provided, filter by displayName/username/email containing search
   - Return array for balance adjustment user selection
   - Include: userId, displayName, username, email, balance, frozenAt

3. Update `adjustUserBalance` to return a signal for real-time notification:
   - After adjusting balance, return { success: true, newBalance, userId } so the admin UI can trigger a socket event
   - Add a new server action `notifyBalanceUpdate(userId: string)`:
     - This action can be called from the admin UI after a successful adjustment
     - It fetches the user's current wallet balance and calls the socket provider's mechanism
     - Since server actions run in Next.js (not server.js), the simplest approach is: the admin UI calls this action which returns the userId, and the admin's client-side code emits a socket event 'admin:balance-adjusted' with { userId }
     - In server.js, add a handler for 'admin:balance-adjusted' that:
       a. Verifies the emitting socket belongs to an admin user
       b. Fetches the affected user's current balance
       c. Emits 'balance:updated' to `user:${userId}` with the new balance
     - This ensures affected users get real-time updates after admin adjustments

Update `src/lib/actions/admin.ts` - `createInvite` function:
- Per GUTH-01: "Neuer Nutzer erhaelt Startguthaben von 1000 (Admin kann bei Einladung ueberschreiben)"
- Add a `customStartingBalance` field to the invite creation flow:
  - Accept optional `customStartingBalance` from formData (parse as integer, can be null/undefined)
  - Store it in the Invite model. The Invite model needs a new optional field: `customStartingBalance Int?`
  - Update prisma/schema.prisma: add `customStartingBalance Int?` to Invite model
  - Run `npx prisma db push` after schema change
- When the invited user registers and their wallet is created (in getWalletWithUser lazy init):
  - Check if the user's invite had a customStartingBalance
  - If yes: use that value instead of SystemSettings.startingBalance
  - If no: use SystemSettings.startingBalance as before
  - This requires updating `getWalletWithUser` in `src/lib/wallet/transactions.ts` to:
    a. When creating a new wallet, look up the user's invite record
    b. If invite has customStartingBalance, use it; otherwise use SystemSettings.startingBalance
    c. Set the initial balance and create the INITIAL transaction with the correct amount

Update `src/components/admin/invite-dialog.tsx`:
- Add an optional "Startguthaben" number input field below the email field:
  - Label: "Individuelles Startguthaben (optional)"
  - Placeholder: show current default from SystemSettings, e.g., "Standard: 1000"
  - If left empty: user gets the global default starting balance
  - If filled: that amount overrides the default for this specific invite
  - Small help text: "Leer lassen fuer Standard-Startguthaben"
- Pass `customStartingBalance` in the formData when calling createInvite
  </action>
  <verify>
`npx tsc --noEmit` passes. `npx prisma db push` succeeds with new Invite field. Server actions are importable and return expected types. Create an invite with custom starting balance, verify it's stored in the Invite record.
  </verify>
  <done>Suspicious activity detection queries work for large transfers, daily limits, and rapid balance drops. User search with wallet info supports balance adjustment UI. Alert thresholds configurable via SystemSettings. Admin can set custom starting balance per invite. Admin balance adjustments can notify affected users via socket event.</done>
</task>

<task type="auto">
  <name>Task 2: Balance adjustment UI, wallet freeze, and alert monitor components</name>
  <files>src/components/admin/balance-adjust.tsx, src/components/admin/alert-monitor.tsx, src/app/(app)/admin/finance/page.tsx</files>
  <action>
Create `src/components/admin/balance-adjust.tsx`:
- 'use client' component

**Single adjustment section:**
- User search input (debounced, calls getUsersWithWallets)
- Dropdown showing matching users with displayName, username, current balance
- On select: show user card with current balance and frozen status
- Amount input (positive = credit, negative = debit) with +/- toggle buttons
- Optional reason textarea
- "Guthaben anpassen" submit button
- Calls adjustUserBalance server action
- After successful adjustment: emit 'admin:balance-adjusted' socket event with { userId } to trigger real-time balance update for the affected user
- Success: toast with new balance, reset form
- Error: toast with error

**Bulk adjustment section:**
- Toggle between "Ausgewaehlte Nutzer" and "Alle Nutzer"
- If selected: multi-select user search (checkboxes next to results)
- If all: warning text "Aenderung wird auf alle Nutzer angewendet"
- Amount input and reason field (same as single)
- "Massenanpassung" submit button with confirmation dialog
- Calls bulkAdjustBalance server action
- After successful bulk adjustment: emit 'admin:balance-adjusted' for each affected userId
- Success: toast with count of affected users

**Freeze section (within user card after selection):**
- If user wallet is not frozen: "Guthaben einfrieren" button (amber/warning style)
- If user wallet is frozen: "Guthaben freigeben" button (green)
- Calls freezeWallet/unfreezeWallet server action
- Shows freeze status with timestamp if frozen
- Tooltip explaining: "Eingefrorene Nutzer koennen spielen aber nicht wetten oder ueberweisen"

Create `src/components/admin/alert-monitor.tsx`:
- 'use client' component
- Fetches alerts on mount via getSuspiciousActivity()
- Auto-refresh every 60 seconds
- Display as alert cards:
  - Color coding: warning (amber border), critical (red border)
  - Icon: ExclamationTriangle for warnings, Shield for critical
  - Content: alert type label in German, user displayName, details, timestamp
  - Alert type labels:
    - large_transfer: "Grosse Ueberweisung"
    - daily_limit: "Tageslimit ueberschritten"
    - balance_drop: "Schneller Guthaben-Verlust"
- If no alerts: green status card "Keine verdaechtigen Aktivitaeten"
- Compact list format, scrollable if many

Update `src/app/(app)/admin/finance/page.tsx`:
- Add two more tab sections:
  - "Guthaben" tab: BalanceAdjust component
  - "Alarme" tab: AlertMonitor component
- So total tabs are: Dashboard | Transaktionen | Guthaben | Alarme | Einstellungen
- Pass initial alert count to tab label: "Alarme ({count})" with red badge if count > 0
  </action>
  <verify>
`npx tsc --noEmit` passes. Navigate to /admin/finance. Switch to "Guthaben" tab, search for a user, adjust their balance - verify the affected user's sidebar balance updates. Switch to "Alarme" tab, verify it loads (may show "Keine verdaechtigen Aktivitaeten"). Freeze a user, verify frozen status shows.
  </verify>
  <done>Admin can adjust single user balance with reason, and affected user gets real-time balance update. Bulk adjustments work for selected or all users. Wallet freeze/unfreeze functional. Suspicious activity alerts display in dedicated tab. All operations logged.</done>
</task>

</tasks>

<verification>
- Admin can search users and adjust balance (positive and negative)
- Balance adjustment shows in user's transaction history
- Affected user's sidebar balance updates after admin adjustment (via socket event)
- Bulk adjustment applies to multiple users
- Wallet freeze prevents outbound operations for that user
- Alert monitor shows suspicious activity (test by creating a large transfer)
- Alert monitor shows "no alerts" when clean
- Invite dialog has optional "Startguthaben" field
- New user invited with custom starting balance receives that amount (not the global default)
- New user invited without custom amount receives global default
- All admin finance tabs load and function
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Admin has full balance management: single adjustments with reason (real-time notification to affected user), bulk adjustments, wallet freeze/unfreeze. Suspicious activity alerts detect large transfers, daily limit violations, and rapid balance drops. Custom starting balance at invitation works. All configurable via SystemSettings thresholds.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-09-SUMMARY.md`
</output>
