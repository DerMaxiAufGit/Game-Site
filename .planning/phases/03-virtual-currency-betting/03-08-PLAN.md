---
phase: 03-virtual-currency-betting
plan: 08
type: execute
wave: 4
depends_on: ["03-02", "03-06", "03-07"]
files_modified:
  - server.js
  - src/components/betting/bet-confirmation.tsx
  - src/components/betting/afk-warning.tsx
  - src/components/game/GameBoard.tsx
  - src/components/game/GameResults.tsx
  - src/components/game/PlayerList.tsx
  - src/components/betting/pot-display.tsx
  - src/components/betting/payout-breakdown.tsx
autonomous: true

must_haves:
  truths:
    - "Buy-in deducted from balance when joining a bet room"
    - "Buy-in refunded when leaving before game starts"
    - "Buy-in forfeited when leaving mid-game or AFK kicked"
    - "Game end distributes pot to winners according to payout ratios"
    - "Confirmation dialog appears when bet exceeds 25% of balance"
    - "Pot is always visible on game board during gameplay"
    - "Results screen shows detailed payout breakdown per player"
    - "Insufficient balance users can join as spectators"
    - "AFK grace period shows warning banner before kick/forfeit in bet rooms"
    - "User can send chips directly from player card via TransferDialog"
  artifacts:
    - path: "server.js"
      provides: "Escrow-integrated room join/leave/game-end with balance operations, AFK warning event emission"
      contains: "BetEscrow"
    - path: "src/components/betting/bet-confirmation.tsx"
      provides: "AlertDialog for high-stakes bet confirmation"
      exports: ["BetConfirmation"]
    - path: "src/components/betting/afk-warning.tsx"
      provides: "AFK grace period warning toast/banner with countdown"
      exports: ["AfkWarning"]
    - path: "src/components/betting/pot-display.tsx"
      provides: "Persistent pot display during gameplay"
      exports: ["PotDisplay"]
    - path: "src/components/betting/payout-breakdown.tsx"
      provides: "Detailed payout per player on results screen"
      exports: ["PayoutBreakdown"]
    - path: "src/components/game/PlayerList.tsx"
      provides: "Player list with 'Chips senden' button per player opening TransferDialog"
      contains: "TransferDialog"
  key_links:
    - from: "server.js (room:join)"
      to: "prisma BetEscrow + Wallet"
      via: "Prisma transaction: debit balance, create PENDING escrow, log BET_PLACED"
      pattern: "betEscrow\\.create"
    - from: "server.js (game end)"
      to: "src/lib/wallet/payout.ts"
      via: "calculatePayouts for prize distribution"
      pattern: "calculatePayouts"
    - from: "server.js (AFK detection)"
      to: "src/components/betting/afk-warning.tsx"
      via: "Socket.IO 'bet:afk-warning' event with grace period countdown"
      pattern: "bet:afk-warning"
    - from: "src/components/betting/pot-display.tsx"
      to: "room state"
      via: "room.isBetRoom && room.betAmount * activePlayers"
      pattern: "totalPot"
    - from: "src/components/game/PlayerList.tsx"
      to: "src/components/wallet/transfer-dialog.tsx"
      via: "TransferDialog import with player userId and displayName"
      pattern: "TransferDialog"
---

<objective>
Escrow-integrated game lifecycle: buy-in on join, refund on pre-game leave, forfeit on mid-game leave, payout on game end. AFK grace period warning UI. Player card transfer integration.

Purpose: This is the core betting integration that connects the financial system to the game lifecycle. Buy-ins create escrow records, game completion triggers payout calculation, and all balance changes are ACID-safe with transaction logging. UI components show pot during play and payout breakdown at results. Per user decision, AFK in bet rooms gets a grace period warning before kick/forfeit. Per user decision, users can send chips directly from player cards.

Output: Full bet lifecycle in server.js, bet confirmation dialog, AFK warning banner, pot display component, payout breakdown component, player card transfer button.
</objective>

<execution_context>
@/home/maxi/.claude/get-shit-done/workflows/execute-plan.md
@/home/maxi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-virtual-currency-betting/03-RESEARCH.md
@.planning/phases/03-virtual-currency-betting/03-01-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-02-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-06-SUMMARY.md
@.planning/phases/03-virtual-currency-betting/03-07-SUMMARY.md
@server.js
@src/lib/wallet/payout.ts
@src/lib/wallet/escrow.ts
@src/components/game/GameBoard.tsx
@src/components/game/GameResults.tsx
@src/components/game/PlayerList.tsx
@src/components/wallet/transfer-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side escrow lifecycle (join buy-in, leave refund/forfeit, game end payout) with AFK warning events</name>
  <files>server.js</files>
  <action>
Update `server.js` to integrate escrow and balance operations:

Import at top (same pattern as existing imports):
```javascript
import { creditBalance, debitBalance, getWalletWithUser, getSystemSettings } from './src/lib/wallet/transactions.js'
import { calculatePayouts } from './src/lib/wallet/payout.js'
import { canTransition } from './src/lib/wallet/escrow.js'
```

Also need Prisma for escrow operations (prisma is already imported).

1. **room:join handler update** - When joining a bet room:
   - Check if room.isBetRoom
   - If bet room:
     a. Fetch wallet: getWalletWithUser(userId)
     b. Check wallet.frozenAt === null (frozen can't bet)
     c. Check balance >= room.betAmount
     d. If insufficient balance: allow join as spectator (add to spectators, not players) with { spectator: true, reason: 'insufficient_balance' }
     e. If sufficient: inside Prisma transaction (Serializable):
        - Debit balance (type: BET_PLACED, description: `Einsatz: ${room.name}`)
        - Create BetEscrow record (status: PENDING, amount: room.betAmount)
     f. After transaction: emit balance:updated to user via `io.to('user:${userId}')`
   - If free room: join as before (no changes)

2. **room:leave handler update** - When leaving a bet room:
   - Check if room.isBetRoom and player was a bettor (not spectator)
   - Find BetEscrow for (roomId, userId)
   - If escrow status is PENDING (game hasn't started):
     a. Inside Prisma transaction:
        - Credit balance back (type: BET_REFUND, description: `Einsatz zurueck: ${room.name}`)
        - Update escrow status to RELEASED, set releasedAt
     b. Emit balance:updated to user
   - If escrow status is LOCKED (game in progress):
     a. Inside Prisma transaction:
        - Update escrow status to FORFEITED
        - Create Transaction (type: BET_FORFEIT, description: `Einsatz verfallen: ${room.name}`)
     b. Do NOT refund balance (already deducted)
     c. Emit balance:updated not needed (no balance change)

3. **game:start handler update** - When game starts:
   - For all bet rooms: update all PENDING escrows to LOCKED (set lockedAt = now())
   - Use Prisma updateMany: where { roomId, status: 'PENDING' }, data { status: 'LOCKED', lockedAt: new Date() }

4. **Game end handler update** (in game:choose-category and autoPlay where phase==='ended'):
   - After detecting game end in a bet room:
     a. Calculate total pot: count LOCKED escrows for room, sum amounts
     b. Build rankings from game results (use game state players sorted by score, detect ties)
     c. Call calculatePayouts(totalPot, rankings, room.payoutRatios)
     d. Inside Prisma transaction:
        - For each winner: creditBalance(userId, payoutAmount, 'GAME_WIN', `${room.name} gewonnen (${position}. Platz)`)
        - Update all escrows to RELEASED (set releasedAt)
     e. After transaction: emit balance:updated to each winner
     f. Include payout info in game:ended event: { payouts: Map<userId, { amount, position }> }

5. **AFK detection in bet rooms** - Per user decision: "AFK in bet rooms gets a grace period warning before kick/forfeit"
   - When AFK timer starts for a player in a bet room:
     a. Fetch SystemSettings.afkGracePeriodSec (default 30)
     b. BEFORE kicking, emit a 'bet:afk-warning' event to the AFK player's socket:
        ```javascript
        io.to(`user:${userId}`).emit('bet:afk-warning', {
          roomId,
          gracePeriodSec: afkGracePeriodSec,
          message: `Du wirst in ${afkGracePeriodSec} Sekunden wegen Inaktivitaet entfernt. Dein Einsatz verfaellt.`
        })
        ```
     c. Start a grace period timeout (afkGracePeriodSec seconds)
     d. If player takes an action during grace period: cancel the kick and emit 'bet:afk-warning-cancel' to clear the warning
     e. If grace period expires without action: proceed with AFK kick and escrow forfeit (same as leaving mid-game)
   - For free rooms: AFK kick works as before (no grace period warning needed, existing behavior is fine)

6. **Helper: buildRankings(gameState)** function:
   - Sort players by total score descending
   - Detect ties (same score = same position)
   - Return FinalRanking[] array
   - Import calculateTotalScore from kniffel-rules

7. Add `payouts` field to room object to store payout results after game end (for results screen).

Note: All database operations (escrow, balance) happen OUTSIDE the in-memory room state updates. The pattern is:
1. Apply game state change (in-memory)
2. Perform database operations (escrow + balance)
3. Emit Socket.IO events AFTER database commits
  </action>
  <verify>
Server starts without errors. Create a bet room. Join with another user - verify balance deducted. Leave before start - verify balance refunded. Start game, leave mid-game - verify no refund. Complete game - verify winner gets payout. AFK in bet room - verify warning event emitted before kick.
  </verify>
  <done>Full escrow lifecycle works: buy-in on join, refund before start, forfeit mid-game, payout on end. AFK grace period warning event emitted before kick in bet rooms. All operations ACID-safe with transaction records. Balance events emitted after each operation.</done>
</task>

<task type="auto">
  <name>Task 2: Bet confirmation, AFK warning, pot display, payout breakdown, and player card transfer button</name>
  <files>src/components/betting/bet-confirmation.tsx, src/components/betting/afk-warning.tsx, src/components/betting/pot-display.tsx, src/components/betting/payout-breakdown.tsx, src/components/game/GameBoard.tsx, src/components/game/GameResults.tsx, src/components/game/PlayerList.tsx</files>
  <action>
Create `src/components/betting/bet-confirmation.tsx`:
- Uses Radix AlertDialog (shadcn pattern - may need to add alert-dialog component: `npx shadcn@latest add alert-dialog`)
- Props: open, betAmount, currentBalance, onConfirm, onCancel
- Shows when bet exceeds 25% of current balance (percentage-based threshold per user decision)
- Content in German:
  - Title: "Hoher Einsatz"
  - Description: "Du setzt {betAmount} Chips ({percentage}% deines Guthabens). Bist du sicher?"
  - Cancel: "Abbrechen"
  - Confirm: "Einsatz bestaetigen"
- Integrate into the room join flow in lobby: when user clicks "Beitreten" on a bet room, check if betAmount > 0.25 * balance, show dialog if so

Create `src/components/betting/afk-warning.tsx`:
- Per user decision: "AFK in bet rooms gets a grace period warning before kick/forfeit"
- 'use client' component
- Listens for 'bet:afk-warning' socket event via useSocket()
- When event received:
  - Display a prominent warning banner/toast at the top of the game board:
    - Red/amber background, pulsing animation for urgency
    - Text: "Inaktivitaet erkannt! Dein Einsatz verfaellt in {countdown} Sekunden."
    - Countdown timer that decrements every second from gracePeriodSec
    - "Ich bin da!" button that emits a 'bet:afk-acknowledge' event to cancel the warning
  - Use toast from sonner for initial notification, PLUS an overlay banner for persistent visibility
- When 'bet:afk-warning-cancel' event received: hide the banner, show brief "Warnung aufgehoben" toast
- Styling: fixed position banner on top of game area, z-50, semi-transparent backdrop
- Does not render anything when no AFK warning is active

Create `src/components/betting/pot-display.tsx`:
- Per user decision: "Pot always visible on game board during gameplay"
- Displays: chip icon + "Pot: {amount} Chips" with amber/gold styling
- Props: totalPot (number), currencyName (string)
- Animated: number ticks up when new player joins
- Compact display suitable for game board header area
- Styling: bg-amber-500/10, text-amber-500, rounded-full pill shape

Create `src/components/betting/payout-breakdown.tsx`:
- Per user decision: "Results screen shows detailed payout breakdown per player"
- Props: payouts (array of { userId, displayName, position, amount }), currencyName
- Display: table/list format
  - Each row: position medal (gold/silver/bronze), displayName, "+{amount} Chips ({position}. Platz)"
  - Winner(s) highlighted
  - Tied positions shown with same medal
- Styling: green text for amounts, matching results screen aesthetic

Update `src/components/game/GameBoard.tsx`:
- Import PotDisplay and AfkWarning
- If room.isBetRoom: render PotDisplay above the game area (between player list and dice scene)
- Calculate totalPot from room.betAmount * activePlayerCount
- Render AfkWarning component (it auto-hides when no warning is active)

Update `src/components/game/GameResults.tsx`:
- Import PayoutBreakdown
- If game was a bet room and payouts exist:
  - Show PayoutBreakdown below the existing podium/rankings
  - Pass payout data from game:ended event
- If free room: show results as before (no payout section)

Update `src/components/game/PlayerList.tsx`:
- Per user decision: "Send money from wallet page OR directly from any user's profile/player card"
- Import TransferDialog from '@/components/wallet/transfer-dialog'
- For each player in the list (except the current user), add a small "Chips senden" button (lucide Send icon, compact):
  - Wrap it in TransferDialog with recipientId={player.userId} and recipientName={player.displayName}
  - The button is the trigger for the dialog
  - Only show when game is NOT in active play (show in waiting room and after game ends, hide during gameplay to avoid distraction)
  - Styling: subtle ghost button, small icon, appears on hover of player card
  </action>
  <verify>
`npx tsc --noEmit` passes. Create bet room, join with second player, verify pot display shows. Play game to completion, verify payout breakdown appears on results screen. Test confirmation dialog: join a bet room with bet > 25% of balance. Test AFK warning: go AFK in a bet room, verify warning banner appears with countdown. Test player card transfer: in waiting room, hover a player, click "Chips senden", verify TransferDialog opens pre-filled.
  </verify>
  <done>Bet confirmation dialog appears for high-stakes bets. AFK grace period warning banner with countdown appears before kick/forfeit in bet rooms. Pot is visible on game board during play. Results screen shows payout breakdown with position and amount per player. Insufficient balance users see spectator option. Player cards have "Chips senden" button opening TransferDialog.</done>
</task>

</tasks>

<verification>
- Join bet room: balance deducted, escrow created (PENDING)
- Leave before start: full refund, escrow RELEASED
- Game starts: escrows transition to LOCKED
- Leave mid-game: escrow FORFEITED, no refund
- Game ends: pot distributed per payout ratios, escrows RELEASED
- Tied players split prize evenly
- Pot display visible on game board for bet rooms
- Payout breakdown visible on results screen
- Confirmation dialog for bets > 25% of balance
- AFK in bet room: warning banner with countdown appears, "Ich bin da!" cancels it
- Player card "Chips senden" button opens transfer dialog pre-filled with recipient
- Free rooms unaffected by all changes
- `npx tsc --noEmit` passes
</verification>

<success_criteria>
Complete bet lifecycle integrated into game flow. Buy-in on join, refund before start, forfeit mid-game, payout on end. Pot visible during play. Detailed payout on results. Confirmation for high stakes. AFK grace period warning with countdown before kick/forfeit in bet rooms. Player cards have transfer button. All operations ACID-safe with transaction logging.
</success_criteria>

<output>
After completion, create `.planning/phases/03-virtual-currency-betting/03-08-SUMMARY.md`
</output>
